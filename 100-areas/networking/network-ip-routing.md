---
title: "IP-адресация и маршрутизация"
created: 2025-01-15
modified: 2025-12-27
tags: [networking, ip, routing, ipv4, ipv6, icmp, arp, nat]
related: [[networking-overview]], [[network-transport-layer]], [[network-cloud-modern]]
---

# IP-адресация и маршрутизация

> Основы Layer 3: IPv4/IPv6 адресация, маршрутизация, NAT, subnetting — всё, что разработчику нужно знать о сетевом уровне.

---

## Prerequisites

| Тема | Зачем нужно | Где изучить |
|------|-------------|-------------|
| **Сетевые основы** | Понимание как работает сеть | [[network-fundamentals-for-developers]] |
| **Физический уровень** | Что такое кадры, MAC-адреса | [[network-physical-layer]] |
| **Биты и байты** | IP-адрес — это 32/128 бит | Computer Science basics |

### Для кого этот материал

| Уровень | Подходит? | Рекомендация |
|---------|-----------|--------------|
| **Новичок** | ⚠️ С подготовкой | Сначала изучи основы |
| **Intermediate** | ✅ Да | Основная аудитория |
| **Advanced** | ✅ Да | BGP и CIDR расчёты |

### Терминология для новичков

> 💡 **IP-адрес** = уникальный адрес компьютера в сети. Как почтовый адрес, только для пакетов данных.

| Термин | Значение | Аналогия для новичка |
|--------|----------|---------------------|
| **IPv4** | 32-битный адрес (192.168.1.1) | **Старый почтовый индекс** — короткий, заканчивается |
| **IPv6** | 128-битный адрес | **Новый длинный индекс** — хватит на всех |
| **Subnet** | Подсеть — часть большой сети | **Район в городе** — группа домов |
| **CIDR** | /24, /16 — нотация размера подсети | **Размер района** — сколько домов поместится |
| **NAT** | Network Address Translation | **Общий почтовый ящик** — один адрес на всех |
| **Router** | Устройство для пересылки пакетов | **Почтовый сортировочный центр** |
| **Default Gateway** | Куда слать пакеты "наружу" | **Выход из района** — если не знаешь куда, иди сюда |
| **ICMP** | Протокол диагностики (ping) | **"Ты живой?"** — проверка связи |
| **ARP** | Преобразование IP в MAC | **"Кто здесь 192.168.1.5?"** — поиск соседа |
| **BGP** | Border Gateway Protocol — маршрутизация интернета | **Глобальная карта дорог** |
| **MTU** | Maximum Transmission Unit | **Максимальный размер посылки** |
| **TTL** | Time To Live — счётчик прыжков | **Срок годности** — сколько маршрутизаторов пройдёт |

---

## Часть 1: Интуиция без кода

### 5 аналогий для глубокого понимания

---

### Аналогия 1: IP-адрес как почтовый адрес

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    IP-АДРЕС = ПОЧТОВЫЙ АДРЕС                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ПОЧТОВЫЙ АДРЕС:                     IP-АДРЕС:                             │
│   ┌────────────────────────────┐      ┌────────────────────────────┐        │
│   │ Страна: Россия             │      │ Сеть верхнего уровня       │        │
│   │ Город: Москва              │      │ 192. (Class C)              │        │
│   │ Район: Центральный         │      │ 192.168. (организация)      │        │
│   │ Улица: Тверская            │      │ 192.168.1. (подсеть/отдел)  │        │
│   │ Дом: 15                    │      │ 192.168.1.100 (устройство)  │        │
│   │ Квартира: 42               │      │                             │        │
│   └────────────────────────────┘      └────────────────────────────┘        │
│                                                                             │
│   АНАЛОГИЯ С CIDR (/24):                                                    │
│   192.168.1.0/24 = "Район Тверская, 1"                                      │
│   ├─────────┤├─┤                                                            │
│     Адрес     Номер                                                         │
│     района    дома                                                          │
│                                                                             │
│   /24 = первые 24 бита = адрес "района"                                     │
│   Последние 8 бит = "номер квартиры" (254 возможных)                        │
│                                                                             │
│   /16 = бОльший район (65534 "квартиры")                                    │
│   /8  = целый город (16 миллионов "квартир")                                │
│                                                                             │
│   КЛЮЧЕВОЕ ОТЛИЧИЕ ОТ MAC:                                                  │
│   • MAC = серийный номер паспорта (прошит в устройство)                     │
│   • IP = почтовый адрес (можно переехать и сменить)                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Аналогия 2: Маршрутизация как GPS-навигатор

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    МАРШРУТИЗАЦИЯ = GPS-НАВИГАТОР                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   GPS-НАВИГАТОР:                                                            │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   "Как доехать до Кремля?"                                        │     │
│   │                                                                   │     │
│   │   1. Если уже в Кремле → ты на месте!                             │     │
│   │   2. Если в Москве → поверни на Тверскую                          │     │
│   │   3. Если в России → езжай в Москву                               │     │
│   │   4. Если не знаю где → езжай к центральной дороге (default)      │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   ROUTING TABLE:                                                            │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   Destination       Gateway           "Куда ехать"                │     │
│   │   ─────────────────────────────────────────────────               │     │
│   │   192.168.1.0/24    0.0.0.0           "Я уже тут!" (direct)       │     │
│   │   10.0.0.0/8        192.168.1.254     "Через перекрёсток А"       │     │
│   │   172.16.0.0/12     192.168.1.253     "Через перекрёсток Б"       │     │
│   │   0.0.0.0/0         192.168.1.1       "Не знаю — к главной дороге"│     │
│   │                                        (default route)            │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   LONGEST PREFIX MATCH = "Самый точный адрес"                               │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   Пакет для 10.20.30.40:                                          │     │
│   │                                                                   │     │
│   │   • 0.0.0.0/0 совпадает? Да (но слишком общий)                    │     │
│   │   • 10.0.0.0/8 совпадает? Да! (более точный)                      │     │
│   │                                                                   │     │
│   │   Выбираем 10.0.0.0/8 → forward через 192.168.1.254               │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Аналогия 3: NAT как общий почтовый ящик офиса

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NAT = ОБЩИЙ ПОЧТОВЫЙ ЯЩИК ОФИСА                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ПРОБЛЕМА:                                                                 │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   100 сотрудников офиса хотят получать посылки из интернета       │     │
│   │   Но у офиса только ОДИН официальный адрес!                       │     │
│   │                                                                   │     │
│   │   Внутри офиса:           Снаружи знают:                          │     │
│   │   Иванов, каб. 101        "Компания АБВ,                          │     │
│   │   Петров, каб. 102         ул. Примерная, 1"                      │     │
│   │   Сидоров, каб. 103                                               │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   РЕШЕНИЕ — NAT (РЕСЕПШН):                                                  │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   1. Иванов (192.168.1.10) хочет заказать книгу                   │     │
│   │      "От: Иванов, каб.101" → Ресепшн переписывает:                │     │
│   │      "От: Компания АБВ, референс #40001"                          │     │
│   │                                                                   │     │
│   │   2. Ресепшн записывает в журнал:                                 │     │
│   │      ┌────────────────────┬──────────────────────┐                │     │
│   │      │ Референс #40001    │ Иванов, каб.101      │                │     │
│   │      │ Референс #40002    │ Петров, каб.102      │                │     │
│   │      │ Референс #40003    │ Сидоров, каб.103     │                │     │
│   │      └────────────────────┴──────────────────────┘                │     │
│   │                                                                   │     │
│   │   3. Посылка приходит: "Для Компании АБВ, реф #40001"             │     │
│   │      Ресепшн смотрит журнал → доставляет Иванову                  │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   В IP-терминах:                                                            │
│   • 192.168.1.10:50000 → 203.0.113.1:40001 (публичный IP + порт)            │
│   • "Референс" = номер порта на внешнем IP                                  │
│   • "Журнал ресепшена" = NAT table                                          │
│                                                                             │
│   ОГРАНИЧЕНИЕ:                                                              │
│   Снаружи НЕЛЬЗЯ позвонить напрямую Иванову!                                │
│   (Нужен port forwarding: "Все звонки на ext 80 → Иванов")                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Аналогия 4: TTL как бензин в баке

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    TTL = БЕНЗИН В БАКЕ                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ПРОБЛЕМА: Что если пакет застрянет в петле?                               │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   Router A → Router B → Router C → Router A → Router B → ...      │     │
│   │                                                                   │     │
│   │   Без TTL: пакет будет крутиться ВЕЧНО!                           │     │
│   │   Сеть забьётся мусором                                           │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   РЕШЕНИЕ — TTL (Time To Live):                                             │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   Пакет отправляется с TTL=64 (бак полный)                        │     │
│   │                                                                   │     │
│   │   Router 1: TTL 64 → 63 (минус литр бензина)                      │     │
│   │   Router 2: TTL 63 → 62                                           │     │
│   │   Router 3: TTL 62 → 61                                           │     │
│   │   ...                                                             │     │
│   │   Router 64: TTL 1 → 0 (БЕНЗИН КОНЧИЛСЯ!)                         │     │
│   │              → Пакет уничтожается                                 │     │
│   │              → ICMP "Time Exceeded" отправителю                   │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   TRACEROUTE ИСПОЛЬЗУЕТ TTL:                                                │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   TTL=1: Пакет → Router 1 → "Бензин кончился!" → ICMP от Router 1 │     │
│   │   TTL=2: Пакет → Router 1 → Router 2 → "Кончился!" → ICMP от R2   │     │
│   │   TTL=3: Пакет → R1 → R2 → R3 → ICMP от R3                        │     │
│   │   ...                                                             │     │
│   │   TTL=N: Пакет доходит до цели → Echo Reply                       │     │
│   │                                                                   │     │
│   │   Так мы узнаём весь маршрут!                                     │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   ТИПИЧНЫЕ ЗНАЧЕНИЯ TTL:                                                    │
│   • Linux: 64                                                               │
│   • Windows: 128                                                            │
│   • Cisco: 255                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Аналогия 5: Subnetting как деление торта

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SUBNETTING = ДЕЛЕНИЕ ТОРТА                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   У тебя есть торт: 192.168.1.0/24 (254 кусочка)                            │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │            ┌─────────────────────────────────────┐                │     │
│   │            │                                     │                │     │
│   │            │      ОДИН БОЛЬШОЙ ТОРТ              │                │     │
│   │            │        192.168.1.0/24               │                │     │
│   │            │         254 кусочка                 │                │     │
│   │            │                                     │                │     │
│   │            └─────────────────────────────────────┘                │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   Делим на 4 части (/26):                                                   │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   ┌──────────────────┬──────────────────┐                         │     │
│   │   │ 192.168.1.0/26   │ 192.168.1.64/26  │                         │     │
│   │   │   62 кусочка     │   62 кусочка     │                         │     │
│   │   │   (Бухгалтерия)  │   (Разработка)   │                         │     │
│   │   ├──────────────────┼──────────────────┤                         │     │
│   │   │ 192.168.1.128/26 │ 192.168.1.192/26 │                         │     │
│   │   │   62 кусочка     │   62 кусочка     │                         │     │
│   │   │   (Маркетинг)    │   (Гости WiFi)   │                         │     │
│   │   └──────────────────┴──────────────────┘                         │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   VLSM = Режем куски РАЗНОГО размера:                                       │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   ┌────────────────────────────────────┬─────────────────────┐    │     │
│   │   │        192.168.1.0/25              │  192.168.1.128/26   │    │     │
│   │   │         126 кусочков               │    62 кусочка       │    │     │
│   │   │      (большой отдел)               │  (средний отдел)    │    │     │
│   │   └────────────────────────────────────┼─────────────────────┤    │     │
│   │                                        │.192/27│.224│.228│.232│   │     │
│   │                                        │  30   │ 2  │ 2  │ 2  │   │     │
│   │                                        │малый  │p2p │p2p │p2p │   │     │
│   │                                        └───────┴────┴────┴────┘   │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   ЗАПОМНИ:                                                                  │
│   • Каждое деление "съедает" 2 кусочка (network + broadcast адреса)         │
│   • /30 = 4 адреса, но только 2 usable (для point-to-point линков)          │
│   • Нельзя "склеить обратно" — планируй заранее!                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Часть 2: Почему это сложно

### 6 типичных ошибок при работе с IP и маршрутизацией

---

### Ошибка 1: Путаница между публичными и приватными IP

**СИМПТОМ:**
```
"Мой сервер на 192.168.1.100, почему друг не может подключиться из интернета?"
"Настроил IP 10.0.0.5 на облачном сервере, но он недоступен"
```

**РЕШЕНИЕ:**
```
ПРИВАТНЫЕ ДИАПАЗОНЫ (RFC 1918) — НЕ маршрутизируются в интернете:

┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   10.0.0.0/8        (10.0.0.0 - 10.255.255.255)                │
│   172.16.0.0/12     (172.16.0.0 - 172.31.255.255)              │
│   192.168.0.0/16    (192.168.0.0 - 192.168.255.255)            │
│                                                                 │
│   Эти адреса:                                                   │
│   ✗ НЕ видны из интернета напрямую                              │
│   ✓ Могут повторяться в разных сетях                            │
│   ✓ Требуют NAT для выхода в интернет                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

ЧТО ДЕЛАТЬ:

Для доступа извне к локальному серверу:
1. Port forwarding на роутере (192.168.1.100:80 → публичный_IP:80)
2. VPN для прямого доступа
3. Туннель (ngrok, Cloudflare Tunnel)

Для облачного сервера:
• Убедись, что используешь ПУБЛИЧНЫЙ IP (не приватный из VPC)
• Проверь Security Groups / Firewall rules
```

---

### Ошибка 2: Конфликт IP-адресов

**СИМПТОМ:**
```
• "Сеть то работает, то нет"
• "ARP table показывает разные MAC для одного IP"
• "Ping иногда работает, иногда нет"
```

**РЕШЕНИЕ:**
```
ПРОБЛЕМА: Два устройства с одинаковым IP в одной сети

┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   [PC1: 192.168.1.100]        [PC2: 192.168.1.100]              │
│          │                           │                          │
│          └───────────┬───────────────┘                          │
│                      │                                          │
│                  [Switch]                                       │
│                      │                                          │
│                  [Router]                                       │
│                                                                 │
│   Router отправляет ARP "Who is 192.168.1.100?"                 │
│   → PC1 отвечает: "Это я, MAC AA:AA..."                         │
│   → PC2 отвечает: "Нет, это я, MAC BB:BB..."                    │
│                                                                 │
│   Router то к PC1, то к PC2 — хаос!                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

ДИАГНОСТИКА:
$ arping -I eth0 192.168.1.100
→ Если приходят ответы с РАЗНЫХ MAC — конфликт!

$ arp -a | grep 192.168.1.100
→ MAC меняется? Конфликт!

РЕШЕНИЕ:
1. DHCP: используй DHCP везде где можно (автоматическое назначение)
2. Резервирование: если нужен статический IP — резервируй в DHCP
3. IP Management: веди учёт IP (IPAM tool)
4. Если нашёл конфликт: найди второе устройство по MAC (OUI lookup)
```

---

### Ошибка 3: Нет маршрута до сети

**СИМПТОМ:**
```
$ ping 10.20.30.40
PING 10.20.30.40: Network is unreachable

$ curl http://10.20.30.40/api
curl: (7) Failed to connect: No route to host
```

**РЕШЕНИЕ:**
```
ПРОБЛЕМА: Система не знает, как добраться до этой сети

ДИАГНОСТИКА:
$ ip route get 10.20.30.40
→ "RTNETLINK answers: Network is unreachable"

$ ip route show
→ Есть ли маршрут для 10.0.0.0/8 или default route?

ЧАСТЫЕ ПРИЧИНЫ:

1. Нет default gateway:
   $ ip route show | grep default
   → Пусто? Нет default route!

   РЕШЕНИЕ: ip route add default via 192.168.1.1

2. Gateway недоступен:
   $ ping 192.168.1.1
   → Не отвечает? Проверь физическое соединение

3. Gateway не знает маршрут:
   $ traceroute 10.20.30.40
   → Пакеты доходят до gateway и дальше не идут?
   → Проблема на стороне gateway/ISP

4. VPN не подключён:
   → 10.x.x.x часто доступны только через VPN
   → Проверь VPN connection

5. Firewall блокирует:
   $ iptables -L -n | grep 10.20
   → Есть DROP/REJECT правило?
```

---

### Ошибка 4: NAT timeout убивает долгие соединения

**СИМПТОМ:**
```
• WebSocket обрывается через 5 минут
• SSH сессия "зависает" после простоя
• TCP keep-alive не помогает
```

**РЕШЕНИЕ:**
```
ПРОБЛЕМА: NAT удаляет неактивные соединения из таблицы

┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   NAT TABLE:                                                    │
│   ┌──────────────────────────┬──────────────────────┐           │
│   │ 192.168.1.10:50000       │ Timeout: 300 sec     │           │
│   │ → 203.0.113.1:40000      │ Last activity: 0     │           │
│   └──────────────────────────┴──────────────────────┘           │
│                                                                 │
│   5 минут без трафика → запись удаляется                        │
│   Следующий пакет от сервера → некуда доставить → DROP          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

РЕШЕНИЯ:

1. Application-level heartbeat:
   • WebSocket: отправляй ping каждые 30 секунд
   • Собственный протокол: добавь heartbeat сообщения

2. TCP Keep-alive (с правильными настройками):
   # Linux:
   sysctl -w net.ipv4.tcp_keepalive_time=60      # начать через 60 сек
   sysctl -w net.ipv4.tcp_keepalive_intvl=10     # интервал 10 сек
   sysctl -w net.ipv4.tcp_keepalive_probes=6     # 6 попыток

3. Для SSH:
   # ~/.ssh/config
   Host *
     ServerAliveInterval 60
     ServerAliveCountMax 3

4. Увеличить NAT timeout (если контролируешь роутер):
   # Linux (netfilter):
   sysctl -w net.netfilter.nf_conntrack_tcp_timeout_established=86400
```

---

### Ошибка 5: Перекрытие подсетей (overlapping subnets)

**СИМПТОМ:**
```
• VPN подключён, но часть сайтов перестала работать
• Локальная сеть и VPN используют одинаковые диапазоны
• "Не могу попасть на 10.0.0.5 — попадаю не туда"
```

**РЕШЕНИЕ:**
```
ПРОБЛЕМА: Две сети используют одинаковый диапазон

┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   Твоя домашняя сеть: 10.0.0.0/24                               │
│   Рабочий VPN: 10.0.0.0/8                                       │
│                                                                 │
│   Пакет для 10.0.0.5:                                           │
│   • Куда идти? В локальную сеть или в VPN?                      │
│   • Routing table: более специфичный маршрут выигрывает         │
│   • /24 более специфичен чем /8 → идёт локально!                │
│   • Но нужный сервер — в VPN...                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

РЕШЕНИЯ:

1. Если контролируешь сеть:
   → Измени диапазон (192.168.X.0/24 вместо 10.X.X.X)

2. Split tunneling VPN:
   → Только рабочий трафик через VPN
   → Настраивается на VPN сервере/клиенте

3. Ручные маршруты:
   # Добавить специфичный маршрут для конкретного хоста
   ip route add 10.0.0.5/32 via VPN_GATEWAY

4. Policy-based routing:
   # Маршрутизация по source IP или приложению
   # Сложно, но иногда единственный вариант

ПРОФИЛАКТИКА:
• Используй разные диапазоны для разных сетей
• Документируй IP-планирование
• 10.0.0.0/8 — слишком популярен, конфликты неизбежны
```

---

### Ошибка 6: ICMP заблокирован — диагностика не работает

**СИМПТОМ:**
```
$ ping 8.8.8.8
PING 8.8.8.8: 0 packets received, 100% packet loss

$ curl http://8.8.8.8
<!DOCTYPE html>... (работает!)

"Ping не работает, но сайт открывается"
```

**РЕШЕНИЕ:**
```
ПРОБЛЕМА: ICMP (ping) заблокирован, но TCP работает

Многие firewall блокируют ICMP по "соображениям безопасности"
(часто неоправданно — ICMP нужен для диагностики и PMTUD!)

ДИАГНОСТИКА БЕЗ ICMP:

1. TCP ping (проверка порта):
   $ nc -zv 8.8.8.8 443
   Connection to 8.8.8.8 443 port [tcp/https] succeeded!

   $ curl -I --connect-timeout 5 http://example.com

2. TCP traceroute:
   $ traceroute -T -p 443 example.com   # Linux
   $ traceroute -P tcp -p 443 example.com  # macOS

3. MTR с TCP:
   $ mtr -T -P 443 example.com

4. Проверка открытых портов:
   $ nmap -Pn -p 80,443 example.com
   # -Pn = не использовать ping для обнаружения

ВАЖНО:
Если контролируешь firewall — НЕ блокируй весь ICMP!
Разрешай как минимум:
• Type 3 (Destination Unreachable) — для PMTUD
• Type 11 (Time Exceeded) — для traceroute
• Type 0/8 (Echo Reply/Request) — для ping
```

---

## Часть 3: Ментальные модели

### 5 способов думать об IP и маршрутизации

---

### Модель 1: Сеть как иерархия почтовых отделений

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  СЕТЬ = ИЕРАРХИЯ ПОЧТОВЫХ ОТДЕЛЕНИЙ                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌─────────────────┐                                 │
│                         │  Главпочтамт    │                                 │
│                         │  (Core Router)  │                                 │
│                         │  "0.0.0.0/0"    │                                 │
│                         └────────┬────────┘                                 │
│                                  │                                          │
│            ┌─────────────────────┼─────────────────────┐                    │
│            │                     │                     │                    │
│    ┌───────┴───────┐     ┌───────┴───────┐     ┌───────┴───────┐            │
│    │ Район А       │     │ Район Б       │     │ Район В       │            │
│    │ 10.0.0.0/8    │     │ 172.16.0.0/12 │     │ 192.168.0.0/16│            │
│    └───────┬───────┘     └───────┬───────┘     └───────┬───────┘            │
│            │                     │                     │                    │
│    ┌───────┴───────┐     ┌───────┴───────┐     ┌───────┴───────┐            │
│    │ Отделение     │     │ Отделение     │     │ Отделение     │            │
│    │ 10.1.0.0/16   │     │ 172.16.1.0/24 │     │ 192.168.1.0/24│            │
│    └───────┬───────┘     └───────────────┘     └───────┬───────┘            │
│            │                                           │                    │
│    ┌───────┴───────┐                           ┌───────┴───────┐            │
│    │ Дом           │                           │ Дом           │            │
│    │ 10.1.1.100    │                           │ 192.168.1.100 │            │
│    └───────────────┘                           └───────────────┘            │
│                                                                             │
│   ПРАВИЛА ДОСТАВКИ:                                                         │
│   1. Письмо для 10.1.1.100 → в Район А → в Отделение 10.1.0.0 → в Дом       │
│   2. Письмо для "куда-то далеко" → в Главпочтамт (default route)           │
│   3. Каждое отделение знает только свой район + путь "наверх"               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Модель 2: IP-пакет как посылка с биркой

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    IP-ПАКЕТ = ПОСЫЛКА С БИРКОЙ                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                          IP HEADER                                  │   │
│   │  ┌───────────────────────────────────────────────────────────────┐  │   │
│   │  │                                                               │  │   │
│   │  │  ОТ КОГО: 192.168.1.10 (Source IP)                            │  │   │
│   │  │  КОМУ: 93.184.216.34 (Destination IP)                         │  │   │
│   │  │                                                               │  │   │
│   │  │  СРОК ГОДНОСТИ: TTL=64 (через 64 пересылки — уничтожить)      │  │   │
│   │  │  ТИП СОДЕРЖИМОГО: Protocol=6 (TCP внутри)                     │  │   │
│   │  │  РАЗМЕР: Total Length=1500 bytes                              │  │   │
│   │  │  ФРАГМЕНТ?: Flags=DF (не разрезать!)                          │  │   │
│   │  │                                                               │  │   │
│   │  └───────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   │  ┌───────────────────────────────────────────────────────────────┐  │   │
│   │  │                         PAYLOAD                               │  │   │
│   │  │                  (содержимое посылки)                         │  │   │
│   │  │                      TCP Segment                              │  │   │
│   │  │                      HTTP Data                                │  │   │
│   │  │                      ...                                      │  │   │
│   │  └───────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   НА КАЖДОМ РОУТЕРЕ (пересылочном пункте):                                  │
│   1. Прочитать "КОМУ" (Destination IP)                                      │
│   2. Уменьшить TTL на 1                                                     │
│   3. Пересчитать checksum                                                   │
│   4. Переслать дальше                                                       │
│                                                                             │
│   Source/Destination IP НЕ МЕНЯЮТСЯ (кроме NAT!)                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Модель 3: ARP как крик "Кто здесь Вася?"

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ARP = КРИК "КТО ЗДЕСЬ ВАСЯ?"                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   СЦЕНАРИЙ: Ты знаешь IP, но не знаешь MAC                                  │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   Ты: "Хочу отправить пакет на 192.168.1.5"                       │     │
│   │                                                                   │     │
│   │   Проблема: Ethernet работает с MAC, не с IP!                     │     │
│   │   Нужно узнать MAC для 192.168.1.5                                │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   ARP ЗАПРОС (broadcast):                                                   │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   📢 "ВНИМАНИЕ ВСЕМ! Кто здесь 192.168.1.5?"                      │     │
│   │       "Если это ты — скажи свой MAC!"                             │     │
│   │       "Мой IP: 192.168.1.10, мой MAC: AA:AA:AA:AA:AA:AA"          │     │
│   │                                                                   │     │
│   │   [PC1] ← слышит, но это не он                                    │     │
│   │   [PC2] ← слышит, но это не он                                    │     │
│   │   [PC3: 192.168.1.5] ← "Это я!"                                   │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   ARP ОТВЕТ (unicast):                                                      │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   PC3 → Ты: "192.168.1.5 это я, мой MAC: BB:BB:BB:BB:BB:BB"       │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   КЭШИРОВАНИЕ:                                                              │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │   Ты записываешь: "192.168.1.5 = BB:BB:BB:BB:BB:BB"               │     │
│   │   Теперь можешь отправлять Ethernet-кадры напрямую!               │     │
│   │   Запись живёт ~20 минут, потом снова ARP                         │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   ВАЖНО: ARP работает только в ЛОКАЛЬНОЙ сети (L2 segment)                  │
│   Для удалённых хостов → ARP для gateway, не для конечного хоста            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Модель 4: Таблица маршрутизации как дорожные указатели

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                ROUTING TABLE = ДОРОЖНЫЕ УКАЗАТЕЛИ                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Представь перекрёсток с указателями:                                      │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐     │
│   │                                                                   │     │
│   │                         [ТЫ ЗДЕСЬ]                                │     │
│   │                              │                                    │     │
│   │        ┌─────────────────────┼─────────────────────┐              │     │
│   │        │                     │                     │              │     │
│   │        ▼                     ▼                     ▼              │     │
│   │   ┌─────────┐          ┌─────────┐          ┌─────────┐          │     │
│   │   │ Москва  │          │ СПб     │          │Все      │          │     │
│   │   │ ← туда  │          │ ← туда  │          │остальные│          │     │
│   │   │         │          │         │          │ ← туда  │          │     │
│   │   │10.0.0.0 │          │172.16.0 │          │0.0.0.0/0│          │     │
│   │   │via eth1 │          │via eth2 │          │via eth0 │          │     │
│   │   └─────────┘          └─────────┘          └─────────┘          │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   В IP-терминах:                                                            │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │ Destination       Gateway         Interface    Metric            │      │
│   │ ────────────────────────────────────────────────────────────     │      │
│   │ 10.0.0.0/8        192.168.1.254   eth1         100               │      │
│   │ 172.16.0.0/12     192.168.1.253   eth2         100               │      │
│   │ 192.168.1.0/24    0.0.0.0         eth0         0   (direct)      │      │
│   │ 0.0.0.0/0         192.168.1.1     eth0         1   (default)     │      │
│   └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│   АЛГОРИТМ "КУДА ЕХАТЬ":                                                    │
│   1. Куда едем? → 10.20.30.40                                               │
│   2. Проверяем указатели (от более к менее специфичному):                   │
│      • 192.168.1.0/24? Нет, не совпадает                                    │
│      • 10.0.0.0/8? ДА! Совпадает!                                           │
│   3. Едем через eth1 к 192.168.1.254                                        │
│                                                                             │
│   Если ничего не совпало → default route (0.0.0.0/0)                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### Модель 5: NAT как переводчик между языками

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NAT = ПЕРЕВОДЧИК МЕЖДУ ЯЗЫКАМИ                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ВНУТРЕННИЙ МИР (приватные IP)   │   ВНЕШНИЙ МИР (публичные IP)            │
│   Говорят на "приватном языке"    │   Говорят на "публичном языке"          │
│                                   │                                         │
│   ┌─────────────────────────┐     │     ┌─────────────────────────┐         │
│   │                         │     │     │                         │         │
│   │  [PC1: 192.168.1.10]    │     │     │  [Server: 93.184.216.34]│         │
│   │  [PC2: 192.168.1.11]    │     │     │                         │         │
│   │  [PC3: 192.168.1.12]    │     │     │  Понимает только        │         │
│   │                         │     │     │  публичные адреса!      │         │
│   │  Говорят: "Я 192.168..."│     │     │                         │         │
│   │                         │     │     └─────────────────────────┘         │
│   └───────────┬─────────────┘     │                   ▲                     │
│               │                   │                   │                     │
│               ▼                   │                   │                     │
│   ┌───────────────────────────────┴───────────────────┴───────────────┐     │
│   │                         NAT ROUTER                                │     │
│   │                       (ПЕРЕВОДЧИК)                                │     │
│   │                                                                   │     │
│   │   Словарь (NAT Table):                                            │     │
│   │   ┌────────────────────────────┬───────────────────────────────┐  │     │
│   │   │ Приватный (внутри)         │ Публичный (снаружи)           │  │     │
│   │   ├────────────────────────────┼───────────────────────────────┤  │     │
│   │   │ 192.168.1.10:50000         │ 203.0.113.1:40000             │  │     │
│   │   │ 192.168.1.11:50001         │ 203.0.113.1:40001             │  │     │
│   │   │ 192.168.1.12:50002         │ 203.0.113.1:40002             │  │     │
│   │   └────────────────────────────┴───────────────────────────────┘  │     │
│   │                                                                   │     │
│   │   ПЕРЕВОД ТУДА (outgoing):                                        │     │
│   │   PC1 говорит: "От: 192.168.1.10:50000, Кому: Server"             │     │
│   │   NAT переводит: "От: 203.0.113.1:40000, Кому: Server"            │     │
│   │                                                                   │     │
│   │   ПЕРЕВОД ОБРАТНО (incoming):                                     │     │
│   │   Server отвечает: "От: Server, Кому: 203.0.113.1:40000"          │     │
│   │   NAT смотрит в словарь: "40000 = PC1"                            │     │
│   │   NAT переводит: "От: Server, Кому: 192.168.1.10:50000"           │     │
│   │                                                                   │     │
│   └───────────────────────────────────────────────────────────────────┘     │
│                                                                             │
│   ПРОБЛЕМА: Снаружи не могут НАЧАТЬ разговор с PC1                          │
│   (нет записи в словаре, пока PC1 сам не позвонит)                          │
│   РЕШЕНИЕ: Port forwarding = "Все звонки на 40080 → переводи на PC1:80"     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Зачем это нужно

**Для разработчика:** Понимание IP-адресации помогает:
- Настраивать сети в Docker/Kubernetes (--network, CNI)
- Диагностировать "нет связи между сервисами"
- Понимать, почему NAT ломает некоторые протоколы
- Читать логи firewall и понимать, что происходит

**Практические ситуации:**
- Сервис не отвечает → traceroute показывает, где проблема
- Pod не видит базу данных → разные подсети, нет маршрута
- VPN работает частично → конфликт приватных диапазонов (10.0.0.0/8)
- WebSocket обрывается через NAT → понимание NAT timeout

**Что вы узнаете:**
1. IPv4/IPv6: структура адресов, CIDR, приватные диапазоны
2. ICMP: ping, traceroute, диагностика
3. ARP: как IP превращается в MAC
4. NAT: типы, port forwarding, проблемы
5. Routing: таблицы маршрутизации, BGP basics

---

## Обзор

Сетевой уровень (Layer 3) отвечает за адресацию и доставку пакетов между различными сетями. Ключевые протоколы:

- **IP (Internet Protocol)** — адресация и маршрутизация пакетов
- **ICMP** — диагностика и сообщения об ошибках
- **ARP** — преобразование IP в MAC-адреса
- **NAT** — трансляция адресов

```
┌─────────────────────────────────────────────────────────────────┐
│                    Network Layer Overview                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Application Layer                                              │
│       │                                                         │
│       ▼                                                         │
│  Transport Layer (TCP/UDP)                                      │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │              Network Layer (IP)                         │    │
│  │                                                         │    │
│  │   ┌───────────┐  ┌───────────┐  ┌───────────┐          │    │
│  │   │    IP     │  │   ICMP    │  │   ARP     │          │    │
│  │   │ Routing   │  │ Diagnostics│  │ Resolution│          │    │
│  │   └───────────┘  └───────────┘  └───────────┘          │    │
│  │                                                         │    │
│  │   Functions:                                            │    │
│  │   • Logical addressing (IP addresses)                   │    │
│  │   • Routing (path selection)                            │    │
│  │   • Fragmentation (MTU handling)                        │    │
│  │   • Error reporting (ICMP)                              │    │
│  │                                                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│       │                                                         │
│       ▼                                                         │
│  Data Link Layer (Ethernet, WiFi)                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## IPv4

### Структура адреса

IPv4 адрес — 32-битное число, обычно записываемое в dotted-decimal нотации.

```
┌─────────────────────────────────────────────────────────────────┐
│                    IPv4 Address Structure                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  192.168.1.100                                                  │
│                                                                 │
│  Бинарное представление:                                        │
│  11000000.10101000.00000001.01100100                            │
│  ────────────────────────────────────                           │
│  8 bits   8 bits   8 bits   8 bits = 32 bits total              │
│                                                                 │
│  Диапазон каждого октета: 0-255                                 │
│  Всего адресов: 2^32 = 4,294,967,296 (~4.3 млрд)                │
│                                                                 │
│  ─────────────────────────────────────────────────────────────  │
│                                                                 │
│  Network vs Host portion (зависит от маски подсети)             │
│                                                                 │
│  192.168.1.100/24                                               │
│  ├────────────┤├┤                                               │
│    Network     Host                                             │
│   (24 bits)   (8 bits)                                          │
│                                                                 │
│  Subnet Mask: 255.255.255.0 (или /24 в CIDR нотации)            │
│                                                                 │
│  11111111.11111111.11111111.00000000                            │
│  ├──────── Network ────────┤├─ Host ─┤                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Классы адресов (устаревшая классификация)

```
┌─────────────────────────────────────────────────────────────────┐
│                 IPv4 Address Classes (Legacy)                   │
├───────┬──────────────────────┬────────────────┬─────────────────┤
│ Class │ Range                │ Default Mask   │ Networks/Hosts  │
├───────┼──────────────────────┼────────────────┼─────────────────┤
│ A     │ 1.0.0.0 -            │ 255.0.0.0      │ 128 networks    │
│       │ 126.255.255.255      │ /8             │ 16M hosts each  │
├───────┼──────────────────────┼────────────────┼─────────────────┤
│ B     │ 128.0.0.0 -          │ 255.255.0.0    │ 16,384 networks │
│       │ 191.255.255.255      │ /16            │ 65K hosts each  │
├───────┼──────────────────────┼────────────────┼─────────────────┤
│ C     │ 192.0.0.0 -          │ 255.255.255.0  │ 2M networks     │
│       │ 223.255.255.255      │ /24            │ 254 hosts each  │
├───────┼──────────────────────┼────────────────┼─────────────────┤
│ D     │ 224.0.0.0 -          │ N/A            │ Multicast       │
│       │ 239.255.255.255      │                │                 │
├───────┼──────────────────────┼────────────────┼─────────────────┤
│ E     │ 240.0.0.0 -          │ N/A            │ Reserved        │
│       │ 255.255.255.255      │                │                 │
└───────┴──────────────────────┴────────────────┴─────────────────┘

Note: Классовая адресация устарела. Сейчас используется CIDR.
```

### CIDR (Classless Inter-Domain Routing)

```
┌─────────────────────────────────────────────────────────────────┐
│                        CIDR Notation                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Формат: IP_address/prefix_length                               │
│                                                                 │
│  Примеры:                                                       │
│  ┌────────────────┬──────────────────┬─────────────────────────┐│
│  │ CIDR           │ Hosts            │ Use case                ││
│  ├────────────────┼──────────────────┼─────────────────────────┤│
│  │ /32            │ 1                │ Single host             ││
│  │ /31            │ 2                │ Point-to-point link     ││
│  │ /30            │ 2 usable         │ Point-to-point link     ││
│  │ /29            │ 6 usable         │ Very small subnet       ││
│  │ /28            │ 14 usable        │ Small office            ││
│  │ /27            │ 30 usable        │ Small department        ││
│  │ /26            │ 62 usable        │ Medium department       ││
│  │ /25            │ 126 usable       │ Large department        ││
│  │ /24            │ 254 usable       │ Standard LAN            ││
│  │ /23            │ 510 usable       │ Large LAN               ││
│  │ /22            │ 1022 usable      │ Campus network          ││
│  │ /16            │ 65,534 usable    │ Large organization      ││
│  │ /8             │ 16,777,214       │ Very large network      ││
│  └────────────────┴──────────────────┴─────────────────────────┘│
│                                                                 │
│  Формула: Usable hosts = 2^(32-prefix) - 2                      │
│  (минус network address и broadcast address)                    │
│                                                                 │
│  Пример расчёта для 192.168.1.0/24:                             │
│  • Network address: 192.168.1.0 (нельзя использовать)           │
│  • First usable:    192.168.1.1                                 │
│  • Last usable:     192.168.1.254                               │
│  • Broadcast:       192.168.1.255 (нельзя использовать)         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Приватные адреса (RFC 1918)

```
┌─────────────────────────────────────────────────────────────────┐
│                   Private IP Ranges                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  RFC 1918 определяет адреса для внутренних сетей:               │
│                                                                 │
│  ┌────────────────────────┬──────────────┬────────────────────┐ │
│  │ Range                  │ CIDR         │ # of Addresses     │ │
│  ├────────────────────────┼──────────────┼────────────────────┤ │
│  │ 10.0.0.0 - 10.255.255.255 │ 10.0.0.0/8    │ 16,777,216      │ │
│  │ 172.16.0.0 - 172.31.255.255 │ 172.16.0.0/12 │ 1,048,576      │ │
│  │ 192.168.0.0 - 192.168.255.255 │ 192.168.0.0/16 │ 65,536       │ │
│  └────────────────────────┴──────────────┴────────────────────┘ │
│                                                                 │
│  Эти адреса:                                                    │
│  • НЕ маршрутизируются в интернете                              │
│  • Можно использовать в любой локальной сети                    │
│  • Требуют NAT для выхода в интернет                            │
│                                                                 │
│  Другие специальные адреса:                                     │
│  ┌────────────────────────┬────────────────────────────────────┐│
│  │ 127.0.0.0/8            │ Loopback (localhost)               ││
│  │ 169.254.0.0/16         │ Link-local (APIPA)                 ││
│  │ 0.0.0.0/8              │ "This" network                     ││
│  │ 255.255.255.255        │ Limited broadcast                  ││
│  │ 100.64.0.0/10          │ Carrier-grade NAT (CGNAT)          ││
│  └────────────────────────┴────────────────────────────────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Заголовок IPv4

```
┌─────────────────────────────────────────────────────────────────┐
│                    IPv4 Header Format                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│    0                   1                   2                   3│
│    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
│   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
│   |Version|  IHL  |    DSCP   |ECN|          Total Length         |
│   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
│   |         Identification        |Flags|      Fragment Offset    |
│   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
│   |  Time to Live |    Protocol   |         Header Checksum       |
│   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
│   |                       Source Address                          |
│   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
│   |                    Destination Address                        |
│   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
│   |                    Options (if IHL > 5)                       |
│   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
│                                                                 │
│   Version (4 bits): 4 для IPv4                                  │
│   IHL (4 bits): Header length в 32-bit словах (min 5 = 20 bytes)│
│   DSCP (6 bits): QoS приоритет                                  │
│   ECN (2 bits): Explicit Congestion Notification                │
│   Total Length (16 bits): Размер пакета (header + data)         │
│   Identification (16 bits): ID для фрагментации                 │
│   Flags (3 bits): DF (Don't Fragment), MF (More Fragments)      │
│   Fragment Offset (13 bits): Позиция фрагмента                  │
│   TTL (8 bits): Время жизни (max hops)                          │
│   Protocol (8 bits): 1=ICMP, 6=TCP, 17=UDP                      │
│   Header Checksum (16 bits): Контрольная сумма заголовка        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## IPv6

### Зачем нужен IPv6

```
┌─────────────────────────────────────────────────────────────────┐
│                    Why IPv6?                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Проблема: IPv4 адреса закончились                              │
│                                                                 │
│  IPv4: 2^32 = ~4.3 млрд адресов                                 │
│  IPv6: 2^128 = ~340 ундециллионов адресов                       │
│        (340,282,366,920,938,463,463,374,607,431,768,211,456)    │
│                                                                 │
│  Преимущества IPv6:                                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ • Огромное адресное пространство                          │  │
│  │ • Упрощённый заголовок (фиксированный размер 40 bytes)    │  │
│  │ • Нет NAT (end-to-end connectivity)                       │  │
│  │ • Встроенная поддержка IPsec                              │  │
│  │ • Автоконфигурация (SLAAC)                                │  │
│  │ • Нет broadcast (только multicast и anycast)              │  │
│  │ • Улучшенная поддержка QoS (Flow Label)                   │  │
│  │ • Нет фрагментации на маршрутизаторах                     │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Формат адреса IPv6

```
┌─────────────────────────────────────────────────────────────────┐
│                    IPv6 Address Format                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  128 бит, записывается в hex, разделённых двоеточиями:          │
│                                                                 │
│  2001:0db8:85a3:0000:0000:8a2e:0370:7334                        │
│  ├──────────────────────────────────────┤                       │
│             8 групп по 16 бит                                   │
│                                                                 │
│  Правила сокращения:                                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 1. Ведущие нули в группе можно опустить:                  │  │
│  │    2001:0db8 → 2001:db8                                   │  │
│  │                                                           │  │
│  │ 2. Одну последовательность нулевых групп можно заменить   │  │
│  │    на :: (только один раз):                               │  │
│  │    2001:db8:0:0:0:0:0:1 → 2001:db8::1                     │  │
│  │                                                           │  │
│  │ 3. Примеры:                                               │  │
│  │    Полный:    2001:0db8:0000:0000:0000:0000:0000:0001     │  │
│  │    Короткий:  2001:db8::1                                 │  │
│  │                                                           │  │
│  │    Полный:    fe80:0000:0000:0000:0000:0000:0000:0001     │  │
│  │    Короткий:  fe80::1                                     │  │
│  │                                                           │  │
│  │    Loopback:  ::1 (полный: 0:0:0:0:0:0:0:1)               │  │
│  │    Unspecified: :: (все нули)                             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Структура адреса:                                              │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                                                            │ │
│  │  2001:0db8:85a3:0000 : 0000:8a2e:0370:7334                 │ │
│  │  ├─────────────────┤   ├──────────────────┤                │ │
│  │     Network Prefix       Interface ID                      │ │
│  │        (64 bits)           (64 bits)                       │ │
│  │                                                            │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Типы IPv6 адресов

```
┌─────────────────────────────────────────────────────────────────┐
│                    IPv6 Address Types                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Global Unicast (GUA) — публичные адреса                        │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Prefix: 2000::/3 (2000:: - 3fff::)                        │  │
│  │ Аналог публичных IPv4 адресов                             │  │
│  │ Маршрутизируются в интернете                              │  │
│  │ Пример: 2001:db8:1234:5678::1                             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Link-Local — только в локальном сегменте                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Prefix: fe80::/10                                         │  │
│  │ Автоматически назначаются на каждом интерфейсе            │  │
│  │ НЕ маршрутизируются                                       │  │
│  │ Используются для neighbor discovery                       │  │
│  │ Пример: fe80::1%eth0                                      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Unique Local (ULA) — приватные адреса                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Prefix: fc00::/7 (fc00:: и fd00::)                        │  │
│  │ Аналог RFC 1918 для IPv4                                  │  │
│  │ НЕ маршрутизируются в интернете                           │  │
│  │ Пример: fd12:3456:789a::1                                 │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Multicast                                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Prefix: ff00::/8                                          │  │
│  │ ff02::1 — все узлы в link-local                           │  │
│  │ ff02::2 — все маршрутизаторы в link-local                 │  │
│  │ ff02::fb — mDNS                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Loopback                                                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Address: ::1                                              │  │
│  │ Аналог 127.0.0.1 в IPv4                                   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ICMP (Internet Control Message Protocol)

### Назначение

ICMP используется для диагностики и сообщений об ошибках в IP-сетях.

```
┌─────────────────────────────────────────────────────────────────┐
│                      ICMP Overview                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ICMP инкапсулируется в IP:                                     │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ IP Header │ ICMP Header │ ICMP Data                         ││
│  │ (Protocol=1)                                                ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  Основные функции:                                              │
│  • Error reporting (Destination Unreachable, Time Exceeded)     │
│  • Diagnostics (Echo Request/Reply — ping)                      │
│  • Path MTU Discovery                                           │
│  • Redirect messages                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Типы ICMP сообщений

```
┌─────────────────────────────────────────────────────────────────┐
│                    ICMP Message Types                           │
├──────┬──────────────────────────────────────────────────────────┤
│ Type │ Message                                                  │
├──────┼──────────────────────────────────────────────────────────┤
│  0   │ Echo Reply (ответ на ping)                               │
│  3   │ Destination Unreachable                                  │
│      │   Code 0: Network unreachable                            │
│      │   Code 1: Host unreachable                               │
│      │   Code 2: Protocol unreachable                           │
│      │   Code 3: Port unreachable                               │
│      │   Code 4: Fragmentation needed, DF set                   │
│  4   │ Source Quench (deprecated)                               │
│  5   │ Redirect                                                 │
│  8   │ Echo Request (ping)                                      │
│ 11   │ Time Exceeded                                            │
│      │   Code 0: TTL expired in transit                         │
│      │   Code 1: Fragment reassembly time exceeded              │
│ 12   │ Parameter Problem                                        │
└──────┴──────────────────────────────────────────────────────────┘
```

### Ping и Traceroute

```
┌─────────────────────────────────────────────────────────────────┐
│                    Ping (ICMP Echo)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Host A                    Router                    Host B     │
│    │                         │                         │        │
│    │  ICMP Echo Request      │                         │        │
│    │  Type=8, Seq=1          │                         │        │
│    │ ────────────────────────┼─────────────────────────>        │
│    │                         │                         │        │
│    │                         │    ICMP Echo Reply      │        │
│    │                         │    Type=0, Seq=1        │        │
│    │ <───────────────────────┼─────────────────────────│        │
│    │                         │                         │        │
│    │  RTT = time(reply) - time(request)                │        │
│    │                         │                         │        │
│                                                                 │
│  $ ping -c 4 google.com                                         │
│  PING google.com (142.250.185.206): 56 data bytes               │
│  64 bytes from 142.250.185.206: icmp_seq=0 ttl=117 time=12.3 ms │
│  64 bytes from 142.250.185.206: icmp_seq=1 ttl=117 time=11.8 ms │
│  64 bytes from 142.250.185.206: icmp_seq=2 ttl=117 time=12.1 ms │
│  64 bytes from 142.250.185.206: icmp_seq=3 ttl=117 time=11.9 ms │
│                                                                 │
│  --- google.com ping statistics ---                             │
│  4 packets transmitted, 4 packets received, 0.0% packet loss    │
│  round-trip min/avg/max/stddev = 11.8/12.0/12.3/0.2 ms          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

```
┌─────────────────────────────────────────────────────────────────┐
│                      Traceroute                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Принцип работы: отправка пакетов с увеличивающимся TTL         │
│                                                                 │
│  Host A         Router 1        Router 2         Host B         │
│    │               │               │               │            │
│    │  TTL=1        │               │               │            │
│    │ ─────────────>│               │               │            │
│    │  Time Exceeded│               │               │            │
│    │ <─────────────│               │               │            │
│    │               │               │               │            │
│    │  TTL=2        │               │               │            │
│    │ ─────────────>│──────────────>│               │            │
│    │               │  Time Exceeded│               │            │
│    │ <─────────────┼───────────────│               │            │
│    │               │               │               │            │
│    │  TTL=3        │               │               │            │
│    │ ─────────────>│──────────────>│──────────────>│            │
│    │               │               │  ICMP Reply   │            │
│    │ <─────────────┼───────────────┼───────────────│            │
│    │               │               │               │            │
│                                                                 │
│  $ traceroute google.com                                        │
│  traceroute to google.com (142.250.185.206), 64 hops max        │
│   1  router.local (192.168.1.1)  1.234 ms  1.123 ms  1.089 ms   │
│   2  10.0.0.1 (10.0.0.1)  5.432 ms  5.321 ms  5.234 ms          │
│   3  isp-router.net (203.0.113.1)  10.123 ms  10.234 ms  10.345 │
│   ...                                                           │
│   9  142.250.185.206 (142.250.185.206)  12.345 ms  12.234 ms    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## ARP (Address Resolution Protocol)

### Назначение

ARP преобразует IP-адреса в MAC-адреса в локальной сети (Layer 2).

```
┌─────────────────────────────────────────────────────────────────┐
│                      ARP Process                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Проблема: IP знает только логические адреса, Ethernet          │
│  работает с физическими (MAC) адресами.                         │
│                                                                 │
│  Host A                                           Host B        │
│  IP: 192.168.1.10                                IP: 192.168.1.20
│  MAC: AA:AA:AA:AA:AA:AA                          MAC: ???       │
│    │                                               │            │
│    │  ARP Request (Broadcast)                      │            │
│    │  "Who has 192.168.1.20? Tell 192.168.1.10"    │            │
│    │ ═══════════════════════════════════════════════════════>   │
│    │                                               │            │
│    │  ARP Reply (Unicast)                          │            │
│    │  "192.168.1.20 is at BB:BB:BB:BB:BB:BB"       │            │
│    │ <─────────────────────────────────────────────│            │
│    │                                               │            │
│    │  (Host A caches: 192.168.1.20 → BB:BB:...)    │            │
│    │                                               │            │
│    │  Now can send Ethernet frames directly        │            │
│    │ ─────────────────────────────────────────────>│            │
│    │                                               │            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### ARP Cache

```
┌─────────────────────────────────────────────────────────────────┐
│                       ARP Cache                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Каждый хост хранит таблицу ARP для ускорения:                  │
│                                                                 │
│  $ arp -a                                                       │
│  ? (192.168.1.1) at 00:11:22:33:44:55 on en0 [ethernet]         │
│  ? (192.168.1.20) at bb:bb:bb:bb:bb:bb on en0 [ethernet]        │
│  ? (192.168.1.30) at cc:cc:cc:cc:cc:cc on en0 [ethernet]        │
│                                                                 │
│  Записи имеют timeout (обычно 20 минут) и обновляются.          │
│                                                                 │
│  ARP для IPv6 НЕ существует — вместо него NDP (Neighbor         │
│  Discovery Protocol), который использует ICMPv6.                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### ARP Spoofing (атака)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ARP Spoofing Attack                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Victim          Attacker           Gateway                     │
│    │                │                  │                        │
│    │  Fake ARP:     │                  │                        │
│    │  "Gateway IP   │                  │                        │
│    │   is at MY MAC"│                  │                        │
│    │ <──────────────│                  │                        │
│    │                │                  │                        │
│    │  Traffic to    │                  │                        │
│    │  gateway goes  │                  │                        │
│    │  to attacker   │                  │                        │
│    │ ──────────────>│ ────────────────>│                        │
│    │                │  (forward)       │                        │
│    │                │                  │                        │
│                                                                 │
│  Man-in-the-Middle позволяет:                                   │
│  • Перехватывать трафик                                         │
│  • Модифицировать данные                                        │
│  • Красть credentials (если нет TLS)                            │
│                                                                 │
│  Защита:                                                        │
│  • Dynamic ARP Inspection (DAI) на свитчах                      │
│  • Static ARP entries                                           │
│  • Использование TLS/HTTPS                                      │
│  • 802.1X authentication                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## NAT (Network Address Translation)

### Концепция

NAT позволяет множеству устройств с приватными адресами использовать один публичный IP.

```
┌─────────────────────────────────────────────────────────────────┐
│                       NAT Overview                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Internal Network                            Internet           │
│  (Private IPs)                               (Public IPs)       │
│                                                                 │
│  ┌─────────────┐                                                │
│  │ PC1         │                                                │
│  │ 192.168.1.10│─┐                                              │
│  └─────────────┘ │                           ┌─────────────┐    │
│                  │      ┌───────────┐        │   Server    │    │
│  ┌─────────────┐ │      │   NAT     │        │             │    │
│  │ PC2         │─┼─────>│  Router   │───────>│ 93.184.216.34    │
│  │ 192.168.1.11│ │      │           │        │             │    │
│  └─────────────┘ │      │Public IP: │        └─────────────┘    │
│                  │      │203.0.113.1│                           │
│  ┌─────────────┐ │      └───────────┘                           │
│  │ PC3         │─┘                                              │
│  │ 192.168.1.12│                                                │
│  └─────────────┘                                                │
│                                                                 │
│  Все внутренние устройства выходят в интернет                   │
│  через один публичный IP: 203.0.113.1                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Типы NAT

```
┌─────────────────────────────────────────────────────────────────┐
│                        NAT Types                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. Static NAT (1:1)                                            │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                                                           │  │
│  │  Internal: 192.168.1.10 ←→ External: 203.0.113.10         │  │
│  │                                                           │  │
│  │  Один приватный IP всегда мапится на один публичный       │  │
│  │  Используется для серверов, которые должны быть доступны  │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  2. Dynamic NAT (Pool)                                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                                                           │  │
│  │  Pool: 203.0.113.10 - 203.0.113.20                        │  │
│  │                                                           │  │
│  │  192.168.1.10 → 203.0.113.10 (пока активно соединение)    │  │
│  │  192.168.1.11 → 203.0.113.11                              │  │
│  │  ...                                                      │  │
│  │                                                           │  │
│  │  Адреса назначаются из пула динамически                   │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  3. PAT / NAPT / NAT Overload (самый распространённый)          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                                                           │  │
│  │  Один публичный IP + разные порты                         │  │
│  │                                                           │  │
│  │  192.168.1.10:50000 → 203.0.113.1:40000                   │  │
│  │  192.168.1.11:50001 → 203.0.113.1:40001                   │  │
│  │  192.168.1.12:50002 → 203.0.113.1:40002                   │  │
│  │                                                           │  │
│  │  Позволяет тысячам устройств использовать один IP         │  │
│  │  (до ~65000 одновременных соединений)                     │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### NAT Table

```
┌─────────────────────────────────────────────────────────────────┐
│                       NAT Table                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  NAT router поддерживает таблицу трансляций:                    │
│                                                                 │
│  ┌────────────────────────┬────────────────────────────────────┐│
│  │ Inside Local           │ Inside Global                      ││
│  │ (Private IP:Port)      │ (Public IP:Port)                   ││
│  ├────────────────────────┼────────────────────────────────────┤│
│  │ 192.168.1.10:50000     │ 203.0.113.1:40000                  ││
│  │ 192.168.1.11:50001     │ 203.0.113.1:40001                  ││
│  │ 192.168.1.10:50002     │ 203.0.113.1:40002                  ││
│  └────────────────────────┴────────────────────────────────────┘│
│                                                                 │
│  Outgoing packet:                                               │
│  1. PC1 sends: src=192.168.1.10:50000, dst=93.184.216.34:80     │
│  2. NAT rewrites: src=203.0.113.1:40000, dst=93.184.216.34:80   │
│  3. Creates table entry                                         │
│                                                                 │
│  Incoming packet:                                               │
│  1. Server responds: src=93.184.216.34:80, dst=203.0.113.1:40000│
│  2. NAT looks up 40000 → 192.168.1.10:50000                     │
│  3. Rewrites: src=93.184.216.34:80, dst=192.168.1.10:50000      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Port Forwarding

```
┌─────────────────────────────────────────────────────────────────┐
│                    Port Forwarding                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Позволяет внешним клиентам подключаться к внутренним серверам  │
│                                                                 │
│  Internet                NAT Router                Internal     │
│                                                                 │
│  Client                  Port Forward Rules:        Web Server  │
│  1.2.3.4  ───────────>  203.0.113.1:80 → 192.168.1.100:80      │
│                         203.0.113.1:443 → 192.168.1.100:443    │
│                         203.0.113.1:22 → 192.168.1.50:22       │
│                                                                 │
│  Конфигурация (iptables):                                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ # Forward port 80 to internal web server                  │  │
│  │ iptables -t nat -A PREROUTING -p tcp \                    │  │
│  │   --dport 80 -j DNAT --to-destination 192.168.1.100:80    │  │
│  │                                                           │  │
│  │ # Allow forwarded traffic                                 │  │
│  │ iptables -A FORWARD -p tcp -d 192.168.1.100 \             │  │
│  │   --dport 80 -j ACCEPT                                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Маршрутизация

### Routing Table

```
┌─────────────────────────────────────────────────────────────────┐
│                      Routing Table                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  $ ip route show (Linux) / route print (Windows)                │
│                                                                 │
│  Destination     Gateway         Genmask         Interface      │
│  ─────────────────────────────────────────────────────────────  │
│  0.0.0.0/0       192.168.1.1     0.0.0.0         eth0   (default)
│  192.168.1.0/24  0.0.0.0         255.255.255.0   eth0   (direct) │
│  10.0.0.0/8      192.168.1.254   255.0.0.0       eth0   (static) │
│  172.16.0.0/16   192.168.1.253   255.255.0.0     eth0   (static) │
│                                                                 │
│  Как работает:                                                  │
│  1. Пакет для 10.20.30.40                                       │
│  2. Проверяем каждую запись (longest prefix match)              │
│  3. 10.20.30.40 matches 10.0.0.0/8                              │
│  4. Forward to gateway 192.168.1.254                            │
│                                                                 │
│  Default route (0.0.0.0/0) — если ничего не совпало             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Процесс маршрутизации

```
┌─────────────────────────────────────────────────────────────────┐
│                   Routing Decision                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Packet arrives:                                                │
│  src: 192.168.1.10                                              │
│  dst: 8.8.8.8 (Google DNS)                                      │
│                                                                 │
│        ┌─────────────────────────────────────────┐              │
│        │         Check routing table             │              │
│        └───────────────────┬─────────────────────┘              │
│                            │                                    │
│                            ▼                                    │
│        ┌─────────────────────────────────────────┐              │
│        │  Is destination in directly connected   │              │
│        │  network? (192.168.1.0/24)              │              │
│        └───────────────────┬─────────────────────┘              │
│                     No     │                                    │
│                            ▼                                    │
│        ┌─────────────────────────────────────────┐              │
│        │  Find longest prefix match              │              │
│        │  8.8.8.8 matches 0.0.0.0/0 (default)    │              │
│        └───────────────────┬─────────────────────┘              │
│                            │                                    │
│                            ▼                                    │
│        ┌─────────────────────────────────────────┐              │
│        │  Forward to gateway: 192.168.1.1        │              │
│        │  via interface: eth0                    │              │
│        └───────────────────┬─────────────────────┘              │
│                            │                                    │
│                            ▼                                    │
│        ┌─────────────────────────────────────────┐              │
│        │  ARP lookup for 192.168.1.1             │              │
│        │  Get MAC address, send frame            │              │
│        └─────────────────────────────────────────┘              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Протоколы маршрутизации

```
┌─────────────────────────────────────────────────────────────────┐
│                  Routing Protocols                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Static Routing (ручная настройка)                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ # Linux                                                   │  │
│  │ ip route add 10.0.0.0/8 via 192.168.1.254                 │  │
│  │                                                           │  │
│  │ ✓ Простота, предсказуемость                               │  │
│  │ ✗ Не масштабируется, нет автовосстановления               │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Interior Gateway Protocols (IGP) — внутри AS                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                                                           │  │
│  │  RIP (Routing Information Protocol)                       │  │
│  │  • Distance-vector                                        │  │
│  │  • Max 15 hops                                            │  │
│  │  • Медленная сходимость                                   │  │
│  │  • Устарел                                                │  │
│  │                                                           │  │
│  │  OSPF (Open Shortest Path First)                          │  │
│  │  • Link-state protocol                                    │  │
│  │  • Dijkstra algorithm                                     │  │
│  │  • Fast convergence                                       │  │
│  │  • Поддержка VLSM, areas                                  │  │
│  │  • Широко используется                                    │  │
│  │                                                           │  │
│  │  EIGRP (Cisco proprietary → теперь открытый)              │  │
│  │  • Advanced distance-vector                               │  │
│  │  • Fast convergence                                       │  │
│  │  • Unequal cost load balancing                            │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Exterior Gateway Protocol (EGP) — между AS                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                                                           │  │
│  │  BGP (Border Gateway Protocol)                            │  │
│  │  • Path-vector protocol                                   │  │
│  │  • Протокол интернета                                     │  │
│  │  • Policy-based routing                                   │  │
│  │  • ~900,000+ routes в full table                          │  │
│  │                                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### BGP (Border Gateway Protocol)

```
┌─────────────────────────────────────────────────────────────────┐
│                       BGP Overview                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  BGP — "клей интернета", соединяет автономные системы (AS)      │
│                                                                 │
│     AS 65001                    AS 65002                        │
│  (Your Company)              (ISP Provider)                     │
│  ┌─────────────┐             ┌─────────────┐                    │
│  │   Router    │◄───BGP────►│   Router    │                    │
│  │             │  session    │             │                    │
│  └─────────────┘             └─────────────┘                    │
│       │                           │                             │
│       │                           │                             │
│  Internal                    AS 65003                           │
│  Network                   (Another ISP)                        │
│                           ┌─────────────┐                       │
│                           │   Router    │                       │
│                           └─────────────┘                       │
│                                                                 │
│  BGP Attributes (влияют на выбор пути):                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ • AS_PATH: список AS, через которые прошёл маршрут        │  │
│  │ • NEXT_HOP: IP следующего роутера                         │  │
│  │ • LOCAL_PREF: preference внутри AS                        │  │
│  │ • MED (Multi-Exit Discriminator): preference между AS     │  │
│  │ • ORIGIN: откуда узнали о маршруте (IGP, EGP, incomplete) │  │
│  │ • COMMUNITY: тэги для policy                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│  BGP выбирает путь по алгоритму (упрощённо):                    │
│  1. Highest LOCAL_PREF                                          │
│  2. Shortest AS_PATH                                            │
│  3. Lowest ORIGIN type                                          │
│  4. Lowest MED                                                  │
│  5. eBGP over iBGP                                              │
│  6. Lowest router ID                                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Subnetting

### Разделение сети на подсети

```
┌─────────────────────────────────────────────────────────────────┐
│                      Subnetting Example                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Задача: разделить 192.168.1.0/24 на 4 подсети                  │
│                                                                 │
│  Исходная сеть:                                                 │
│  192.168.1.0/24 = 254 usable hosts                              │
│                                                                 │
│  Для 4 подсетей нужно 2 бита (2^2 = 4):                         │
│  /24 → /26                                                      │
│                                                                 │
│  Результат:                                                     │
│  ┌────────────────────┬──────────────────┬─────────────────────┐│
│  │ Subnet             │ Range            │ Usable hosts        ││
│  ├────────────────────┼──────────────────┼─────────────────────┤│
│  │ 192.168.1.0/26     │ .1 - .62         │ 62                  ││
│  │ 192.168.1.64/26    │ .65 - .126       │ 62                  ││
│  │ 192.168.1.128/26   │ .129 - .190      │ 62                  ││
│  │ 192.168.1.192/26   │ .193 - .254      │ 62                  ││
│  └────────────────────┴──────────────────┴─────────────────────┘│
│                                                                 │
│  Бинарное представление:                                        │
│  192.168.1.0   = 11000000.10101000.00000001.00|000000           │
│  192.168.1.64  = 11000000.10101000.00000001.01|000000           │
│  192.168.1.128 = 11000000.10101000.00000001.10|000000           │
│  192.168.1.192 = 11000000.10101000.00000001.11|000000           │
│                                        subnet│ host             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### VLSM (Variable Length Subnet Masking)

```
┌─────────────────────────────────────────────────────────────────┐
│                         VLSM                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  VLSM позволяет использовать разные размеры подсетей            │
│                                                                 │
│  Требования:                                                    │
│  • Dept A: 100 hosts                                            │
│  • Dept B: 50 hosts                                             │
│  • Dept C: 25 hosts                                             │
│  • Point-to-point links: 2 hosts each (x3)                      │
│                                                                 │
│  Распределение 192.168.1.0/24:                                  │
│  ┌────────────────────┬──────────┬──────────────────────────────┐
│  │ Subnet             │ Mask     │ Hosts needed / available     │
│  ├────────────────────┼──────────┼──────────────────────────────┤
│  │ 192.168.1.0/25     │ /25      │ 100 / 126                    │
│  │ 192.168.1.128/26   │ /26      │ 50 / 62                      │
│  │ 192.168.1.192/27   │ /27      │ 25 / 30                      │
│  │ 192.168.1.224/30   │ /30      │ 2 / 2                        │
│  │ 192.168.1.228/30   │ /30      │ 2 / 2                        │
│  │ 192.168.1.232/30   │ /30      │ 2 / 2                        │
│  └────────────────────┴──────────┴──────────────────────────────┘
│                                                                 │
│  Остаток: 192.168.1.236/30 - 192.168.1.255 (для будущего роста) │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Практические команды

### Диагностика сети (Linux/macOS)

```bash
# IP-адрес и интерфейсы
ip addr show                    # Linux
ifconfig                        # macOS / legacy Linux

# Routing table
ip route show                   # Linux
netstat -rn                     # macOS

# ARP cache
ip neigh show                   # Linux
arp -a                          # macOS

# DNS lookup
dig example.com
nslookup example.com
host example.com

# Connectivity test
ping -c 4 google.com
ping6 -c 4 google.com           # IPv6

# Path tracing
traceroute google.com
traceroute -I google.com        # ICMP mode
mtr google.com                  # Combined ping + traceroute

# Port scanning
nc -zv host 80                  # TCP port check
nc -zvu host 53                 # UDP port check

# Network statistics
ss -tulpn                       # Linux: listening ports
netstat -an                     # macOS: all connections

# Packet capture
tcpdump -i eth0 port 80
tcpdump -i any icmp
```

### Конфигурация (Linux)

```bash
# Добавить IP адрес
ip addr add 192.168.1.100/24 dev eth0

# Добавить маршрут
ip route add 10.0.0.0/8 via 192.168.1.1

# Удалить маршрут
ip route del 10.0.0.0/8

# Включить IP forwarding (роутинг)
echo 1 > /proc/sys/net/ipv4/ip_forward
sysctl -w net.ipv4.ip_forward=1

# NAT с iptables
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Port forwarding
iptables -t nat -A PREROUTING -p tcp --dport 80 \
    -j DNAT --to-destination 192.168.1.100:80
```

---

## Связанные темы

- [[networking-overview]] — обзор сетевых технологий
- [[network-transport-layer]] — TCP, UDP, QUIC
- [[network-dns-tls]] — DNS и безопасность
- [[network-physical-layer]] — Ethernet, WiFi, MAC
- [[network-cloud-modern]] — облачные сетевые технологии
- [[os-networking]] — сетевой стек ОС

---

## Источники

- [RFC 791 - Internet Protocol](https://datatracker.ietf.org/doc/html/rfc791)
- [RFC 8200 - IPv6 Specification](https://datatracker.ietf.org/doc/html/rfc8200)
- [RFC 792 - ICMP](https://datatracker.ietf.org/doc/html/rfc792)
- [RFC 826 - ARP](https://datatracker.ietf.org/doc/html/rfc826)
- [RFC 1918 - Private Addresses](https://datatracker.ietf.org/doc/html/rfc1918)
- [RFC 4271 - BGP-4](https://datatracker.ietf.org/doc/html/rfc4271)

---

*Последнее обновление: 2026-01-09 — Добавлены педагогические секции: 5 аналогий (IP-почтовый адрес, маршрутизация-GPS, NAT-почтовый ящик офиса, TTL-бензин, subnetting-торт), 6 типичных ошибок IP/routing с диагностикой, 5 ментальных моделей для понимания сетевого уровня*
