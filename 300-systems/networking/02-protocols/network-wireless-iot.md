---
title: "Беспроводные IoT протоколы: Zigbee, Thread, Matter, NFC, LoRa"
created: 2025-12-18
modified: 2026-02-13
type: concept
status: published
confidence: high
sources_verified: true
tags:
  - topic/networking
  - networking/wireless
  - networking/iot
  - hardware/embedded
  - type/concept
  - level/intermediate
related:
  - "[[network-bluetooth]]"
  - "[[network-physical-layer]]"
  - "[[networking-overview]]"
  - "[[android-networking]]"
prerequisites:
  - "[[network-physical-layer]]"
  - "[[network-fundamentals-for-developers]]"
reading_time: 182
difficulty: 6
study_status: not_started
mastery: 0
last_reviewed:
next_review:
---

# Беспроводные IoT протоколы: Zigbee, Thread, Matter, NFC, LoRa

Zigbee/Thread — mesh для умного дома (15.4). Matter — унификация экосистем (Apple + Google + Amazon). NFC — касание для платежей (13.56 MHz). LoRa — километры на батарейке (LPWAN). Выбор зависит от дальности, энергопотребления и топологии.

---

## Prerequisites

Прежде чем изучать IoT-протоколы, рекомендуется понимать:

| Тема | Зачем нужно | Где изучить |
|------|-------------|-------------|
| **OSI модель** | IoT-протоколы работают на разных уровнях (физический, сетевой, прикладной) | [[networking-overview]] |
| **IP и IPv6** | Thread использует IPv6, понимание адресации важно | [[networking-overview]] |
| **Радиочастоты** | 2.4 GHz, 868 MHz — почему разные диапазоны для разных задач | Базовая физика |
| **Шифрование** | AES-128 используется во всех протоколах | [[security-cryptography]] |
| **Bluetooth** | BLE часто сравнивают с Zigbee, используется для Matter commissioning | [[network-bluetooth]] |

### Для кого этот материал

| Уровень | Подходит? | Рекомендация |
|---------|-----------|--------------|
| **Новичок** | ⚠️ Специализированно | Сначала сетевые основы |
| **Intermediate** | ✅ Да | Для IoT разработчиков |
| **Advanced** | ✅ Да | Mesh networking, Matter |

### Терминология для новичков

> 💡 **IoT (Internet of Things)** = обычные устройства с интернетом. Лампочка, которой управляешь с телефона. Датчик, который отправляет данные в облако.

| Термин | Значение | Аналогия для новичка |
|--------|----------|---------------------|
| **Zigbee** | Mesh-протокол для умного дома | **Сарафанное радио** — устройства передают друг другу |
| **Thread** | IPv6 mesh-протокол | **Zigbee с интернетом** — то же, но по IP |
| **Matter** | Единый стандарт умного дома | **USB-C для умного дома** — работает везде |
| **NFC** | Near Field Communication | **Касание для оплаты** — несколько сантиметров |
| **LoRa** | Long Range — километры на батарейке | **Радио для датчиков** — далеко, но медленно |
| **Mesh** | Сеть где устройства передают друг другу | **Эстафета** — каждый передаёт следующему |
| **Gateway** | Мост между IoT и интернетом | **Переводчик** — соединяет миры |
| **Coordinator** | Управляющее устройство в сети | **Дирижёр** — организует работу |
| **LPWAN** | Low-Power Wide Area Network | **Почта для IoT** — далеко, экономно |
| **Commissioning** | Добавление устройства в сеть | **Регистрация** — подключить к системе |

---

## Часть 1: Интуиция без кода

> 🎯 **Цель секции:** Понять IoT-протоколы через сравнение и визуализации, прежде чем погружаться в технические детали.

### Аналогия 1: Выбор транспорта для доставки

**Проблема:** Какой протокол выбрать для моего проекта?

```
IoT ПРОТОКОЛЫ = ТРАНСПОРТ ДЛЯ ДОСТАВКИ

Что везём?          Какой транспорт?         Аналог протокола
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  📦 Коробка             🏍️ Мотокурьер           WiFi
  до 5 кг               Быстро, близко          Быстро, ближний
  срочно                (в пределах города)     радиус, много энергии

  📬 Письма              🚴 Велокурьеры          Zigbee/Thread
  много адресов         передают друг другу     Mesh, средняя
  по району             (сеть эстафеты)         дальность, экономно

  💳 Подпись             🤝 Личная встреча       NFC
  секретная             (рукопожатие)           Безопасно, касание,
  одноразовая                                    мгновенно

  🌡️ Показания           🐦 Почтовый голубь      LoRa
  раз в час             15 км, крошечная        Очень далеко,
  от датчика в поле     записка                 медленно, годами

  🏷️ Универсальная        📋 Единая накладная     Matter
  этикетка              для всех служб          Работает поверх
                                                 любого транспорта
```

**Ключевой инсайт:**
> "Нет лучшего протокола. Есть правильный для твоей задачи. LoRa для датчика в поле, Zigbee для умной лампы, NFC для оплаты."

---

### Аналогия 2: Mesh vs Star — Сеть передачи vs Хаб

**Проблема:** Почему Zigbee/Thread "надёжнее" WiFi?

```
STAR TOPOLOGY (WiFi):             MESH TOPOLOGY (Zigbee/Thread):

         📡 Router                        🔵──🔵──🔵
        /  |  \                          /  \ /  \
       /   |   \                        🔵   🔵   🔵
      💡  💡  💡                        |   / \   |
      ↑         ↑                      🔵──🔵──🔵
      │         │
  Умерла     Тоже умер!              🔵 умер? Данные идут другим путём!
   точка      (всё через центр)       🔵──────────🔵
                                          ↑
                                     Сеть выжила!

ПРОБЛЕМА STAR:                      ПРЕИМУЩЕСТВО MESH:
• Роутер умер = всё умерло          • Любой узел умер = остальные работают
• Далеко от роутера = плохой сигнал • Чем больше устройств = лучше покрытие
• Перегрузка центра                 • Самовосстановление маршрутов
```

**Zigbee устройства по ролям:**
| Роль | Функция | Пример устройства |
|------|---------|-------------------|
| **Coordinator** | Управляет сетью, один на сеть | Hub умного дома |
| **Router** | Передаёт сообщения, всегда включён | Розетка, лампа (с питанием) |
| **End Device** | Только отправляет свои данные, спит | Датчик движения, кнопка |

**Почему датчики — End Device?**
> "Датчик на батарейке не может быть роутером. Он спит 99% времени, просыпается, отправляет данные, и снова спит. Поэтому в Zigbee-сети нужны устройства с постоянным питанием для маршрутизации."

---

### Аналогия 3: Thread vs Zigbee — IPv6 меняет всё

**Проблема:** Зачем Thread если есть Zigbee?

```
ZIGBEE (старый подход):

  Интернет
      │
  ┌───┴───┐
  │ Cloud │
  └───┬───┘
      │ (HTTP/MQTT)
  ┌───┴───┐
  │  Hub  │ ← Переводчик! (Zigbee ↔ IP)
  └───┬───┘
      │ (Zigbee собственный протокол)
  ┌───┴───┐
  │ 💡💡💡 │  Zigbee адреса: 0x1234, 0x5678
  └───────┘

Проблема: Hub — единая точка отказа!
          Команда: App → Cloud → Hub → Лампа (3 посредника!)

THREAD (современный подход):

  Интернет (IPv6)
      │
  ┌───┴───────────────┐
  │ Border Router     │ ← Просто роутер (не переводчик!)
  └───┬───────────────┘
      │ (всё тот же IPv6!)
  ┌───┴───┐
  │ 💡💡💡 │  Thread адреса: fd00::1234, fd00::5678 (IPv6!)
  └───────┘

Преимущество: Лампа имеет IP-адрес!
              Команда: App → Лампа (напрямую!)
```

**Ключевое отличие:**
| Аспект | Zigbee | Thread |
|--------|--------|--------|
| Адресация | Собственная (16-bit) | IPv6 (128-bit) |
| Доступ из интернета | Через hub/cloud | Напрямую по IP |
| Зависимость от облака | Часто обязательна | Опциональна |
| Базовая технология | IEEE 802.15.4 | IEEE 802.15.4 (та же!) |

**Ключевой инсайт:**
> "Thread и Zigbee используют **один и тот же радио-чип** (802.15.4). Разница в софте: Thread говорит на IPv6, Zigbee — на своём языке."

---

### Аналогия 4: Matter — USB-C для умного дома

**Проблема:** Почему Apple HomeKit не видит Google Home устройства?

```
ДО MATTER (2020):

  ┌─────────┐   ┌─────────┐   ┌─────────┐
  │  Apple  │   │ Google  │   │ Amazon  │
  │ HomeKit │   │  Home   │   │  Alexa  │
  └────┬────┘   └────┬────┘   └────┬────┘
       │             │             │
   Свой язык     Свой язык     Свой язык
       │             │             │
  ┌────┴────┐   ┌────┴────┐   ┌────┴────┐
  │ Philips │   │ Philips │   │ Philips │
  │ Hue v1  │   │ Hue v2  │   │ Hue v3  │
  └─────────┘   └─────────┘   └─────────┘
      ↑             ↑             ↑
  3 прошивки для ОДНОЙ лампы! 💸

С MATTER (2022+):

  ┌─────────┐   ┌─────────┐   ┌─────────┐
  │  Apple  │   │ Google  │   │ Amazon  │
  │ HomeKit │   │  Home   │   │  Alexa  │
  └────┬────┘   └────┬────┘   └────┬────┘
       │             │             │
       └─────────────┼─────────────┘
                     │
                  MATTER ← Единый язык!
                     │
              ┌──────┴──────┐
              │ Philips Hue │
              │  (одна      │
              │  прошивка!) │
              └─────────────┘
```

**Что Matter НЕ делает:**
- ❌ Не заменяет WiFi/Thread/Ethernet (это транспорт)
- ❌ Не делает устройства совместимыми магически (нужна прошивка)
- ❌ Не работает без экосистемы (нужен контроллер)

**Что Matter ДЕЛАЕТ:**
- ✅ Единый язык команд ("включи свет", "установи 50%")
- ✅ Единый процесс добавления (QR-код)
- ✅ Мульти-админ (одно устройство в Apple + Google + Amazon)

---

### Аналогия 5: LoRa vs Cellular — Почтовый голубь vs Сотовая связь

**Проблема:** Зачем LoRa если есть 4G/5G?

```
СРАВНЕНИЕ ДЛЯ ДАТЧИКА ТЕМПЕРАТУРЫ В ПОЛЕ

                    LoRa                    4G/LTE
                    ────                    ──────
Батарея:           🔋🔋🔋🔋🔋               🔋
                   10 лет                  3-6 месяцев

Стоимость          $0 (своя сеть)          $5-10/месяц
подключения:       или <$1/год (TTN)       за SIM-карту

Дальность:         15+ км (rural)          Зависит от вышки
                   2-5 км (urban)          (нет вышки = нет связи)

Скорость:          0.3-50 kbps             10+ Mbps
                   (открытка)              (видеопоток)

Инфраструктура:    Свой gateway            Оператор (Билайн, МТС)
                   ~$100-300               Нужна SIM, договор

КОГДА ЧТО ВЫБИРАТЬ:

┌────────────────────────────────────────────────────────────────┐
│                                                                 │
│  📊 Данные: "температура=23.5"    → LoRa (хватит, дёшево)      │
│  📹 Данные: видеопоток           → 4G/5G (много данных)        │
│                                                                 │
│  🔋 Питание: солнечная батарея   → LoRa (потребление микроватты)│
│  🔌 Питание: от сети             → Любой (не ограничен)        │
│                                                                 │
│  🗺️ Место: своя ферма           → LoRa (свой gateway)          │
│  🌍 Место: по всему миру         → 4G (инфраструктура есть)    │
│                                                                 │
└────────────────────────────────────────────────────────────────┘
```

---

## Часть 2: Почему это сложно

> ⚠️ **Цель секции:** Разобрать типичные ошибки при выборе и внедрении IoT-протоколов.

### Ошибка 1: Выбор протокола по хайпу, а не по задаче

**СИМПТОМ:**
```
"Thread — будущее! Переводим все датчики на Thread!"
Через год: 50% датчиков не работают, батарейки садятся быстро.
```

**Проблема:**
```
Thread battery life для End Device: ~2-3 года ✓
НО: Thread Router должен быть ВСЕГДА включён!

Если у вас сеть из 20 датчиков на батарейках без устройств с питанием:
  ❌ Нет роутеров → нет mesh → плохое покрытие
  ❌ Датчики не могут спать (ждут роутинг-запросы)
  ❌ Батарейки садятся за месяцы

Zigbee в той же ситуации:
  ✅ End Devices просто спят и просыпаются для отправки
  ✅ Coordinator справляется с маршрутизацией
```

**РЕШЕНИЕ:**
```
МАТРИЦА ВЫБОРА ПРОТОКОЛА:

Условие                          │ Рекомендация
─────────────────────────────────┼─────────────────────
Много устройств с питанием?      │ Thread (mesh + IPv6)
Только батарейные датчики?       │ Zigbee или BLE
Нужен доступ по IP напрямую?     │ Thread
Дальность > 100м?                │ LoRa или Sub-GHz Zigbee
Интеграция Apple+Google+Amazon?  │ Matter (поверх Thread/WiFi)
Только один вендор?              │ Его проприетарный (дешевле)
```

---

### Ошибка 2: Matter — "магическая совместимость"

**СИМПТОМ:**
```
"Купил Matter-лампочку, а она не работает в HomeKit!"
```

**Проблема:**
```
Matter ≠ автоматическая совместимость!

Для работы Matter нужно:
1. Устройство с Matter прошивкой ← есть ✓
2. Контроллер Matter (Apple TV, HomePod, Nest Hub) ← часто нет!
3. Правильный транспорт (Thread или WiFi) ← нужна сеть!

Типичная ошибка:
┌─────────────────────────────────────────────────────────────┐
│ Купил: Matter over Thread лампочку                         │
│                                                             │
│ Дома есть: iPhone + WiFi роутер                            │
│                                                             │
│ НЕТ: Thread Border Router!                                 │
│      (Apple TV 4K, HomePod mini, или Nest Hub)             │
│                                                             │
│ Результат: Лампочка не видна 💀                            │
└─────────────────────────────────────────────────────────────┘
```

**РЕШЕНИЕ:**
```
ПЕРЕД ПОКУПКОЙ Matter устройства проверьте:

1. Какой транспорт? (Thread или WiFi)
   └── Thread: нужен Border Router
   └── WiFi: работает через обычный роутер

2. Какой контроллер у вас?
   ┌──────────────────────────────────────────┐
   │ Экосистема   │ Thread Border Router      │
   ├──────────────┼────────────────────────────┤
   │ Apple        │ Apple TV 4K, HomePod mini │
   │ Google       │ Nest Hub (2nd gen), Nest  │
   │ Amazon       │ Echo (4th gen), eero 6+   │
   │ Samsung      │ SmartThings Station       │
   └──────────────┴────────────────────────────┘

3. Протестируйте ДО покупки пачки устройств!
```

---

### Ошибка 3: Zigbee mesh "само построится"

**СИМПТОМ:**
```
"Поставил 10 датчиков в квартире, половина отваливается."
```

**Проблема:**
```
Zigbee mesh требует РОУТЕРЫ, а не только End Devices!

Плохая топология:

  ┌─────┐
  │ HUB │ (Coordinator)
  └──┬──┘
     │
  ┌──┴──┐
  │Датчик│ (End Device, спит)
  └─────┘
     ↓ 10 метров, 2 стены
  ┌─────┐
  │Датчик│ (End Device, спит)  ← Плохой сигнал!
  └─────┘

End Device НЕ РЕТРАНСЛИРУЕТ!
```

**РЕШЕНИЕ:**
```
Правило: 1 Router на каждые 3-5 End Devices

Хорошая топология:

  ┌─────┐
  │ HUB │
  └──┬──┘
     │
  ┌──┴──┐
  │Розетка│ (Router, питание от сети) ← Усиливает сигнал!
  └──┬──┘
     │
  ┌──┴──┐
  │Датчик│ (End Device)
  └─────┘
     ↓
  ┌─────┐
  │Лампа │ (Router, питание от сети) ← Ещё один ретранслятор
  └──┬──┘
     │
  ┌──┴──┐
  │Датчик│ (End Device, далеко от хаба) ← Теперь работает!
  └─────┘

УСТРОЙСТВА-РОУТЕРЫ (с постоянным питанием):
• Умные розетки
• Умные лампочки
• Повторители Zigbee
```

---

### Ошибка 4: LoRa для "всех" IoT задач

**СИМПТОМ:**
```
"LoRa на 15 км — поставлю везде!"
Через месяц: данные приходят через раз, время отклика 10+ секунд.
```

**Проблема:**
```
LoRa ограничения, которые не упоминают в рекламе:

1. DUTY CYCLE ограничение (в EU/RU):
   ┌─────────────────────────────────────────────────────────┐
   │ LoRaWAN EU868: можно передавать ТОЛЬКО 1% времени!     │
   │                                                         │
   │ Передал 2 секунды → ждёшь 198 секунд (3+ минуты)!      │
   │                                                         │
   │ Хочешь отправлять каждую минуту? НЕЛЬЗЯ!              │
   └─────────────────────────────────────────────────────────┘

2. СКОРОСТЬ:
   0.3-50 kbps — это ~300 байт за передачу
   Забудь про: фото, большие JSON, firmware updates

3. LATENCY:
   Class A (самый экономичный): устройство слушает ТОЛЬКО после передачи
   → Команда дойдёт только после следующей передачи датчика
   → Задержка управления: минуты!
```

**РЕШЕНИЕ:**
```
LoRa подходит для:
✅ Данные раз в час (температура, уровень воды)
✅ Фиксированные точки (датчик в поле)
✅ Односторонняя передача (сенсор → сервер)
✅ Годами без обслуживания

LoRa НЕ подходит для:
❌ Умный дом (нужна реактивность)
❌ Управление в реальном времени
❌ Частые передачи (> 1 раз в 5 минут)
❌ Большие объёмы данных
```

---

### Ошибка 5: NFC "как Bluetooth, только ближе"

**СИМПТОМ:**
```
"Сделаем NFC-передачу файлов!"
Результат: передача 1 MB занимает минуты, пользователи злятся.
```

**Проблема:**
```
NFC vs Bluetooth — СОВЕРШЕННО разные задачи!

                     NFC                  Bluetooth
                     ───                  ─────────
Дальность:           <10 см              10-100 м
Скорость:            424 kbps            2-3 Mbps
Время соединения:    <0.1 сек            2-6 сек
Режим работы:        Tap-and-go          Постоянное соединение

NFC = ИНИЦИАЦИЯ, не передача данных!
```

**РЕШЕНИЕ:**
```
Правильное использование NFC:

✅ TAP для ИНИЦИАЦИИ:
   1. Tap телефон к колонке
   2. NFC передаёт: "Мой Bluetooth MAC: AA:BB:CC:DD:EE:FF"
   3. Bluetooth соединяется мгновенно
   4. Музыка играет

✅ TAP для АВТОРИЗАЦИИ:
   1. Tap карту к турникету
   2. NFC передаёт: токен 256 байт
   3. Турникет проверяет
   4. Проход открыт (мгновенно!)

❌ НЕПРАВИЛЬНО:
   - Передача файлов через NFC (используй AirDrop/Bluetooth)
   - Стриминг через NFC (используй WiFi)
```

---

### Ошибка 6: Игнорирование интерференции на 2.4 GHz

**СИМПТОМ:**
```
"Zigbee работал, поставил новый WiFi роутер — всё отвалилось."
```

**Проблема:**
```
2.4 GHz — ПЕРЕПОЛНЕННЫЙ диапазон!

┌─────────────────────────────────────────────────────────────────┐
│                    2.4 GHz ДИАПАЗОН                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   WiFi Ch 1    WiFi Ch 6    WiFi Ch 11                          │
│   ████████     ████████     ████████                            │
│                                                                  │
│   Zigbee channels: 11-26                                         │
│   ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░                        │
│           ↑↑↑↑              ↑↑↑↑                                 │
│       Пересечение!     Пересечение!                              │
│                                                                  │
│   + Bluetooth: тоже здесь!                                       │
│   + Микроволновка: 2.45 GHz 💀                                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**РЕШЕНИЕ:**
```bash
# Рекомендованные сочетания каналов:

WiFi Channel  │  Zigbee Channels (безопасные)
──────────────┼────────────────────────────────
     1        │  25, 26 (далеко от WiFi)
     6        │  15, 16 (между WiFi 1 и 6)
    11        │  20, 21 (между WiFi 6 и 11)

# Проверить текущий Zigbee канал:
# (в интерфейсе вашего Zigbee координатора)

# Изменить при помех:
# Zigbee2MQTT: configuration.yaml → advanced → channel: 25
# deCONZ: настройки → изменить канал
# Hue Bridge: перезагрузка может выбрать лучший канал
```

---

## Часть 3: Ментальные модели

> 🧠 **Цель секции:** Дать системные способы думать о IoT-протоколах для правильного выбора.

### Модель 1: Треугольник IoT ограничений

**Принцип:** Нельзя иметь всё. Выбирай 2 из 3.

```
                    ДАЛЬНОСТЬ
                        △
                       /│\
                      / │ \
                     /  │  \
                    /   │   \
                   /  LoRa   \
                  /   NB-IoT  \
                 /      │      \
                /       │       \
               /        │        \
              ──────────┼──────────
             /          │          \
     ЭНЕРГО-/   WiFi    │    ?     \ СКОРОСТЬ
     ЭФФЕКТ.\  Thread   │   (нет   / (Mbps)
            \  Zigbee   │ решения)/
             \   BLE    │        /
              \         │       /
               \        │      /
                ────────┴──────
                   ОГРАНИЧЕНИЕ!

НЕ СУЩЕСТВУЕТ протокола:
  ✗ 10 км дальность
  ✗ 100 Mbps скорость
  ✗ 10 лет на батарейке

РЕАЛЬНЫЕ КОМПРОМИССЫ:
┌────────────────┬───────────┬──────────┬──────────┐
│ Протокол       │ Дальность │ Скорость │ Батарея  │
├────────────────┼───────────┼──────────┼──────────┤
│ LoRa           │ ★★★★★    │ ★        │ ★★★★★   │
│ Zigbee         │ ★★        │ ★★       │ ★★★★    │
│ Thread         │ ★★        │ ★★       │ ★★★     │
│ BLE            │ ★         │ ★★       │ ★★★★    │
│ WiFi           │ ★★        │ ★★★★★   │ ★        │
│ NFC            │ ☆         │ ★        │ ★★★★★   │
└────────────────┴───────────┴──────────┴──────────┘
```

---

### Модель 2: Дерево принятия решений

**Принцип:** Ответь на 4 вопроса — получи протокол.

```
ВЫБОР IoT ПРОТОКОЛА

Начало
   │
   ▼
┌──────────────────────────────────────┐
│ Q1: Дальность > 500м?                │
└──────────────────┬───────────────────┘
         │                    │
        ДА                   НЕТ
         │                    │
         ▼                    ▼
    ┌────────────┐     ┌──────────────────────────────┐
    │ LoRa или   │     │ Q2: Нужен мгновенный отклик? │
    │ Cellular   │     │     (<100ms)                  │
    └────────────┘     └──────────────┬───────────────┘
                               │              │
                              ДА             НЕТ
                               │              │
                               ▼              ▼
                    ┌──────────────┐   ┌─────────────────────┐
                    │ Q3: Питание  │   │ Q4: Совместимость   │
                    │     от сети? │   │     Apple+Google+..?│
                    └──────┬───────┘   └──────────┬──────────┘
                     │          │           │           │
                    ДА        НЕТ          ДА         НЕТ
                     │          │           │           │
                     ▼          ▼           ▼           ▼
                 ┌──────┐   ┌──────┐   ┌──────┐   ┌──────────┐
                 │ WiFi │   │ BLE  │   │Matter│   │Zigbee or │
                 │Thread│   │      │   │      │   │proprietary│
                 └──────┘   └──────┘   └──────┘   └──────────┘
```

---

### Модель 3: Слои IoT стека

**Принцип:** Matter — это НЕ протокол передачи, это язык команд поверх протокола.

```
IoT ПРОТОКОЛЬНЫЙ СТЕК

┌─────────────────────────────────────────────────────────────┐
│                    APPLICATION LAYER                         │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  Умный дом: "Включи свет", "Температура 22°C"          ││
│  │  Промышленность: "Статус машины", "Уровень топлива"    ││
│  └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│                INTEROPERABILITY LAYER                        │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                        MATTER                           ││
│  │  Единый язык команд для Apple, Google, Amazon, Samsung  ││
│  │  (Matter НЕ передаёт данные, Matter ОПИСЫВАЕТ данные)   ││
│  └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│                   NETWORK LAYER (IP)                         │
│  ┌───────────────────┐  ┌───────────────────┐              │
│  │      IPv6         │  │      IPv4         │              │
│  │ (Thread, WiFi)    │  │ (только WiFi)     │              │
│  └───────────────────┘  └───────────────────┘              │
├─────────────────────────────────────────────────────────────┤
│                   TRANSPORT LAYER                            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │  WiFi   │ │ Thread  │ │ Zigbee  │ │Ethernet │           │
│  │         │ │ (mesh)  │ │ (mesh)  │ │         │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
├─────────────────────────────────────────────────────────────┤
│                   PHYSICAL LAYER                             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │  2.4 GHz (WiFi, Zigbee, Thread, BLE)                   ││
│  │  Sub-GHz (LoRa 868/915 MHz, Z-Wave 868/908 MHz)        ││
│  │  13.56 MHz (NFC)                                        ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘

Ключевой инсайт:
  Matter работает ПОВЕРХ Thread или WiFi.
  Zigbee работает БЕЗ IP (свой стек).
  Thread = Zigbee радио + IPv6 стек.
```

---

### Модель 4: Lifecycle стоимости IoT

**Принцип:** Дешёвый датчик ≠ дешёвое решение. Считай TCO.

```
TOTAL COST OF OWNERSHIP (5 лет, 100 датчиков)

                    WiFi              Zigbee            LoRa
                    ────              ──────            ────
Датчики:           $5 × 100          $8 × 100         $15 × 100
                   = $500            = $800           = $1,500

Hub/Gateway:       $0 (есть роутер)  $50 × 1          $300 × 1
                   = $0              = $50            = $300

Батарейки          $2 × 100 × 10     $2 × 100 × 3     $2 × 100 × 1
(замены за 5 лет): = $2,000 😱       = $600           = $200

Облако/SIM:        $0 (локально)     $0 (локально)    $0 (своя сеть)
                   или $5/мес×60     или $5/мес×60    или $1/мес×60×100
                   = $0-300          = $0-300         = $0-6,000

Обслуживание:      Высокое           Среднее          Низкое
(замена батарей)   (раз в 6 мес)     (раз в 1-2 года) (раз в 5+ лет)

─────────────────────────────────────────────────────────────────
ИТОГО (5 лет):     $2,500-2,800      $1,450-1,750     $2,000-7,800

Вывод:
• WiFi кажется бесплатным, но батарейки съедают бюджет
• Zigbee — золотая середина для умного дома
• LoRa — экстремальная экономия если своя инфраструктура
```

---

### Модель 5: Матрица безопасности IoT

**Принцип:** Каждый протокол имеет разные угрозы и защиту.

```
БЕЗОПАСНОСТЬ IoT ПРОТОКОЛОВ

Протокол │ Шифрование    │ Основная угроза        │ Защита
─────────┼───────────────┼────────────────────────┼────────────────────
WiFi     │ WPA3 (AES-256)│ Подбор пароля          │ Сложный пароль,
         │               │ Evil Twin AP           │ WPA3, изолир. сеть

Zigbee   │ AES-128       │ Key sniffing при       │ Install code,
         │               │ joining                │ Touchlink disable

Thread   │ AES-128 +     │ Компрометация Border   │ Secure commissioning,
         │ DTLS          │ Router                 │ Certificate-based

Matter   │ CASE (AES-128)│ Компрометация          │ Device attestation,
         │               │ supply chain           │ Trusted QR codes

NFC      │ Опционально   │ Relay attack           │ Проверка присутствия,
         │ (зависит)     │ (ретрансляция)         │ короткий таймаут

LoRa     │ AES-128       │ Replay attacks,        │ Frame counter,
         │               │ Gateway compromise     │ ABP→OTAA миграция

ЗОЛОТЫЕ ПРАВИЛА IoT БЕЗОПАСНОСТИ:
┌─────────────────────────────────────────────────────────────────┐
│ 1. Изолируй IoT от основной сети (отдельный VLAN/WiFi)         │
│ 2. Отключи облачные сервисы если возможно (локальный контроль) │
│ 3. Регулярно обновляй прошивки (особенно coordinator/gateway)  │
│ 4. Используй secure commissioning (не "open" режимы)           │
│ 5. Мониторь аномальный трафик (неожиданные соединения)         │
└─────────────────────────────────────────────────────────────────┘
```

---

## Аналогия: IoT как система почтовых служб

Представьте, что вам нужно доставить сообщение в разные части города и за город. Каждый IoT-протокол — это отдельная "почтовая служба" со своими особенностями:

```
┌─────────────────────────────────────────────────────────────────────────┐
│                IoT ПРОТОКОЛЫ КАК ПОЧТОВЫЕ СЛУЖБЫ                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  📬 ZIGBEE = Районная почта с курьерами-волонтёрами                     │
│     Курьеры (роутеры) передают письма друг другу, пока те               │
│     не дойдут до адресата. Работает только в пределах района.           │
│     Каждый курьер "знает" соседей, но не весь город.                    │
│                                                                          │
│  🌐 THREAD = Та же районная почта, но с GPS-адресами                    │
│     Письма имеют IPv6-адрес — можно отправить из любой                  │
│     точки мира напрямую. Нужен "пограничный пункт" (Border Router)      │
│     для связи с внешним миром.                                          │
│                                                                          │
│  🤝 MATTER = Единый формат конвертов для ВСЕХ почтовых служб            │
│     Раньше Почта России, DHL, FedEx использовали разные форматы.        │
│     Matter — договорённость: "конверт 10x15, адрес сверху".             │
│     Теперь одно письмо принимают все службы.                            │
│                                                                          │
│  👆 NFC = Передача записки при рукопожатии                              │
│     Можно передать только если прикоснуться (<10 см).                   │
│     Безопасно — никто не перехватит издалека.                           │
│     Идеально для передачи ключей и паролей.                             │
│                                                                          │
│  📡 LoRa = Почтовые голуби с крошечными записками                       │
│     Летят на 15+ км, но несут только ~50 символов за раз.               │
│     Идеальны для сообщений типа "температура: 23°C".                    │
│     Голубь может летать 10 лет на одной еде (батарейке).                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

ГЛАВНЫЙ ПРИНЦИП: Нельзя иметь всё сразу!

┌────────────────────────────────────────────────┐
│        ДАЛЬНОСТЬ ←──────────→ СКОРОСТЬ         │
│              ↑                                  │
│              │                                  │
│              ↓                                  │
│       ЭНЕРГОПОТРЕБЛЕНИЕ                         │
└────────────────────────────────────────────────┘

• Хочешь далеко? Жертвуй скоростью (LoRa: 15 км, но 0.3 kbps)
• Хочешь быстро? Жертвуй дальностью (WiFi: 100 Mbps, но 50 м)
• Хочешь экономить батарею? Жертвуй и тем, и другим
```

---

## История: Как появились IoT-протоколы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    ХРОНОЛОГИЯ IoT ПРОТОКОЛОВ                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1998 ──── NFC: Sony и Philips начинают исследования                    │
│                                                                          │
│  2002 ──── NFC: Philips и Sony создают техническую спецификацию         │
│                                                                          │
│  2003 ──── IEEE 802.15.4: Стандарт физического уровня                   │
│            (фундамент для Zigbee и Thread)                               │
│            NFC: Утверждён как ISO/IEC стандарт                          │
│                                                                          │
│  2004 ──── ZIGBEE: Спецификация 1.0 ратифицирована                      │
│            NFC Forum: Основан Nokia, Philips, Sony                      │
│                                                                          │
│  2005 ──── ZIGBEE: Публичный релиз Zigbee 2004                          │
│                                                                          │
│  2006 ──── ZIGBEE 2006: Улучшенная версия                               │
│                                                                          │
│  2007 ──── ZIGBEE PRO: Home Automation Profile                          │
│                                                                          │
│  2009 ──── LoRa: Начало разработки во Франции (Cycleo)                  │
│                                                                          │
│  2012 ──── LoRa: Semtech приобретает Cycleo                             │
│                                                                          │
│  2014 ──── THREAD: Thread Group основан                                 │
│            (Google Nest, Samsung, ARM, Silicon Labs)                     │
│                                                                          │
│  2015 ──── LoRaWAN: Первая спецификация, LoRa Alliance основан          │
│            THREAD: Спецификация 1.0 выпущена                            │
│                                                                          │
│  2016 ──── ZIGBEE 3.0: Унификация всех профилей                         │
│                                                                          │
│  2019 ──── Project CHIP: Apple, Google, Amazon объединяются             │
│            (будущий Matter)                                              │
│                                                                          │
│  2021 ──── CHIP переименован в MATTER                                   │
│            Zigbee Alliance → Connectivity Standards Alliance             │
│            LoRaWAN: Стандарт ITU                                         │
│                                                                          │
│  2022 ──── MATTER 1.0: Официальный релиз (октябрь)                      │
│                                                                          │
│  2023 ──── MATTER 1.2: Новые устройства (пылесосы, холодильники)        │
│                                                                          │
│  2024+ ─── Thread/Matter становятся стандартом де-факто                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**Почему так много протоколов?** Каждый создавался для решения конкретной проблемы в своё время:

- **Zigbee (2004)** — первая попытка создать mesh-сеть для умного дома. WiFi потреблял слишком много энергии, Bluetooth не поддерживал mesh. Zigbee Alliance объединил производителей.

- **NFC (2004)** — Sony и Philips объединили усилия для создания стандарта бесконтактных платежей. Короткий радиус действия — не баг, а фича безопасности.

- **LoRa (2012)** — французские инженеры Nicolas Sornin, Olivier Seller и François Sforza решали проблему передачи показаний счётчиков без сотовой связи. Semtech увидел потенциал и купил их стартап Cycleo.

- **Thread (2014)** — Google Nest понял главную проблему Zigbee: он не говорит на языке интернета. Thread добавил IPv6, позволив адресовать каждое устройство напрямую.

- **Matter (2022)** — исторические конкуренты Apple, Google, Amazon наконец договорились. Пользователи устали от несовместимости "работает только с Alexa".

---

## Терминология

| Термин | Значение |
|--------|----------|
| **IEEE 802.15.4** | Стандарт физ. уровня для Zigbee/Thread |
| **Mesh Network** | Сеть, где узлы ретранслируют данные |
| **LPWAN** | Low Power Wide Area Network |
| **LoRa** | Long Range — модуляция Semtech |
| **LoRaWAN** | Протокол поверх LoRa |
| **NFC** | Near Field Communication (~10 см) |
| **NDEF** | NFC Data Exchange Format |
| **Matter** | Unified IoT standard (бывш. CHIP) |
| **Thread** | IPv6 mesh protocol для IoT |
| **Border Router** | Мост между Thread и IP сетью |

---

## Сравнение IoT протоколов

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    СРАВНЕНИЕ IoT ПРОТОКОЛОВ                              │
├─────────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┤
│             │ Zigbee  │ Thread  │ Z-Wave  │   NFC   │  LoRa   │  BLE    │
├─────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Частота     │ 2.4 GHz │ 2.4 GHz │ 868/915 │ 13.56   │ 868/915 │ 2.4 GHz │
│             │         │         │   MHz   │   MHz   │   MHz   │         │
├─────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Дальность   │ 10-100м │ 10-100м │  30м    │  ~10см  │ 2-15 км │ 10-100м │
├─────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Скорость    │ 250     │ 250     │ 100     │ 424     │ 0.3-50  │ 1-2     │
│             │ kbps    │ kbps    │ kbps    │ kbps    │ kbps    │ Mbps    │
├─────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Топология   │ Mesh    │ Mesh    │ Mesh    │ P2P     │ Star    │ Star/   │
│             │         │         │         │         │         │ Mesh    │
├─────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Макс. узлов │ 65,000  │ 250+    │ 232     │ 2       │ 1000s   │ 7-∞     │
├─────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Батарея     │ Годы    │ Годы    │ Годы    │ Пассив  │ 10+ лет │ Месяцы- │
│             │         │         │         │         │         │ годы    │
├─────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ IP-based    │ Нет     │ Да      │ Нет     │ Нет     │ Нет     │ Нет*    │
├─────────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ Применение  │ Smart   │ Smart   │ Smart   │ Платежи │ Sensors │ Wearab- │
│             │ Home    │ Home    │ Home    │ Метки   │ Города  │ les     │
└─────────────┴─────────┴─────────┴─────────┴─────────┴─────────┴─────────┘

* BLE имеет IPSP (IP Support Profile), но редко используется
```

**Почему такие частоты?** 2.4 GHz и 868/915 MHz — нелицензируемые ISM-диапазоны, производителям не нужно платить за спектр. 2.4 GHz доступен глобально, но перегружен (WiFi, Bluetooth, микроволновки). Sub-GHz диапазоны (868 в ЕС, 915 в США) менее загружены и лучше проникают сквозь стены, но требуют разных версий устройств для разных регионов.

**Компромисс дальность/скорость/энергия:** Законы физики — нельзя иметь всё. LoRa жертвует скоростью (0.3 kbps) ради дальности (15 км). BLE жертвует дальностью ради скорости. Zigbee/Thread — баланс для умного дома. Mesh-топология увеличивает покрытие ценой сложности и задержек.

### Выбор протокола по use case

```
┌─────────────────────────────────────────────────────────────────┐
│                    DECISION TREE                                 │
└─────────────────────────────────────────────────────────────────┘

Нужна дальность > 1 км?
├── ДА → LoRaWAN / NB-IoT / LTE-M
│        (LPWAN для сенсоров, Cellular для мобильных)
│
└── НЕТ → Нужен mesh?
          ├── ДА → Много устройств (>50)?
          │        ├── ДА → Zigbee / Thread
          │        └── НЕТ → Z-Wave / Thread
          │
          └── НЕТ → Нужно касание / NFC?
                    ├── ДА → NFC
                    │        (платежи, метки, pairing)
                    │
                    └── НЕТ → BLE
                             (wearables, audio, sensors)
```

---

## Zigbee

### Почему появился Zigbee?

В начале 2000-х WiFi и Bluetooth не подходили для умного дома: WiFi потреблял слишком много энергии для батарейных датчиков, Bluetooth не поддерживал mesh и ограничивался 7 устройствами. Нужен был протокол с:
- **Низким энергопотреблением** — годы работы от батарейки
- **Mesh-топологией** — самовосстановление сети, расширение покрытия
- **Тысячами узлов** — масштабирование для всего дома/здания

IEEE 802.15.4 (2003) стал физическим фундаментом, а Zigbee Alliance добавил сетевой и прикладной уровни. Название "Zigbee" — метафора: пчёлы в улье передают информацию "зигзагообразными танцами", как данные прыгают между узлами mesh-сети.

### Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                     ZIGBEE STACK                                 │
├─────────────────────────────────────────────────────────────────┤
│  Application Layer                                               │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ ZCL (Zigbee Cluster Library)                              │  │
│  │ - On/Off Cluster, Level Control, Color Control            │  │
│  │ - Temperature, Occupancy, IAS (Security)                  │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  Network Layer (NWK)                                             │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ - Mesh routing (AODV-based)                               │  │
│  │ - 16-bit network addresses                                │  │
│  │ - Security: Network key encryption                        │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  MAC Layer (IEEE 802.15.4)                                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ - CSMA-CA access                                          │  │
│  │ - 64-bit IEEE addresses                                   │  │
│  │ - 16 channels (11-26) @ 2.4 GHz                          │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  Physical Layer (IEEE 802.15.4)                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ - O-QPSK modulation                                       │  │
│  │ - 250 kbps data rate                                      │  │
│  │ - 2.4 GHz ISM band                                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

**Почему 4 уровня, а не один протокол?** Разделение ответственности: физический уровень (IEEE 802.15.4) стандартизирован и используется также Thread. Это позволяет производителям чипов (Texas Instruments, Silicon Labs) выпускать универсальные радиомодули. Zigbee добавляет своё только на сетевом уровне (маршрутизация, адресация) и прикладном (ZCL — стандартные команды для ламп, датчиков).

**Почему 250 kbps достаточно?** Датчик температуры отправляет ~10 байт раз в минуту. Лампа получает команду ON/OFF — ещё меньше. При 250 kbps один канал может обслужить сотни устройств без коллизий. Скорость намеренно низкая — чем медленнее передача, тем надёжнее при слабом сигнале.

### Типы устройств

```
┌─────────────────────────────────────────────────────────────────┐
│                    ZIGBEE DEVICE TYPES                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  COORDINATOR (ZC)           ROUTER (ZR)           END DEVICE    │
│  ┌─────────────┐           ┌─────────────┐       ┌───────────┐  │
│  │     ★       │           │     ◆       │       │     ●     │  │
│  │  Trust      │           │  Routing    │       │  Sleepy   │  │
│  │  Center     │           │  + Repeat   │       │  Device   │  │
│  └─────────────┘           └─────────────┘       └───────────┘  │
│                                                                  │
│  - Один на сеть            - Много в сети        - Батарейные   │
│  - Формирует PAN           - Всегда включены     - Спят         │
│  - Раздаёт ключи           - Маршрутизируют      - Не роутят    │
│  - Обычно hub              - Лампы, розетки      - Датчики      │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Mesh топология:                                                 │
│                                                                  │
│         ●───◆───●                                               │
│             │                                                    │
│     ●───◆───★───◆───●      ★ = Coordinator                      │
│         │       │          ◆ = Router                           │
│         ●       ◆───●      ● = End Device                       │
│                 │                                                │
│                 ●                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Зачем три типа устройств?** Экономия энергии через специализацию:
- **Coordinator** — один на сеть, формирует PAN ID, раздаёт ключи шифрования. Обычно это хаб с постоянным питанием.
- **Router** — ретранслирует пакеты, расширяет покрытие. Лампы и розетки подключены к сети 220V, им не нужно экономить батарею.
- **End Device** — датчики движения, температуры. Спят 99.9% времени, просыпаются отправить данные. Router-родитель хранит сообщения для спящего устройства.

**Почему mesh, а не звезда?** В звезде при падении центра падает вся сеть. В mesh пакет найдёт альтернативный маршрут. Плюс mesh позволяет покрыть большую площадь: каждый роутер — ретранслятор. Минус: сложность и непредсказуемая задержка (пакет может пройти через 5+ узлов).

### Zigbee Cluster Library (ZCL)

```
Стандартные кластеры:

General:
├── Basic (0x0000)         - Device info, reset
├── Power Configuration    - Battery status
├── Identify (0x0003)      - Blink/flash device
├── Groups (0x0004)        - Group membership
├── Scenes (0x0005)        - Scene recall
├── On/Off (0x0006)        - Binary switch
├── Level Control (0x0008) - Dimming
└── Color Control (0x0300) - Hue, Saturation, XY

Measurement:
├── Temperature (0x0402)
├── Humidity (0x0405)
├── Illuminance (0x0400)
└── Occupancy (0x0406)

Security:
├── IAS Zone (0x0500)      - Motion, door/window
├── IAS ACE (0x0501)       - Arm/disarm panel
└── IAS WD (0x0502)        - Warning device (siren)
```

**Зачем нужна ZCL?** До ZCL каждый производитель изобретал свой формат команд. Лампа Philips не понимала команду от выключателя IKEA. ZCL стандартизировала: кластер 0x0006 (On/Off) — это всегда бинарный переключатель, атрибут 0x0000 — текущее состояние. Теперь любой выключатель может управлять любой лампой, если оба поддерживают ZCL.

**Что даёт ZCL на практике:**

```
БЕЗ ZCL (проприетарный протокол):
─────────────────────────────────
Philips Hue выключатель → [команда: 0x42 0x01]
                        → Работает только с Philips Hue лампой

IKEA Tradfri выключатель → [команда: 0x80 0x00 0x01]
                         → Работает только с IKEA лампой

C ZCL (стандарт):
─────────────────
Любой ZCL выключатель → [cluster: 0x0006, cmd: On, endpoint: 1]
                      → Работает с ЛЮБОЙ ZCL лампой

Практический пример:
• Датчик движения Aqara (ZCL Occupancy 0x0406)
• Лампа IKEA (ZCL On/Off 0x0006)
• Связываем через Zigbee2MQTT: датчик → лампа
• Работает, хотя производители разные!
```

**Кластеры — как API для устройств:** Думайте о кластере как о REST endpoint. On/Off кластер имеет методы (On, Off, Toggle) и атрибуты (OnOff: bool). Любой клиент, знающий API, может управлять любым устройством.

### Zigbee vs Zigbee 3.0

```
┌──────────────────────────────────────────────────────────────┐
│            ZIGBEE EVOLUTION                                   │
├───────────────┬──────────────────────────────────────────────┤
│ Zigbee HA     │ Home Automation profile                      │
│ Zigbee LL     │ Light Link profile (лампы Philips Hue)       │
│ Zigbee SE     │ Smart Energy profile                         │
├───────────────┴──────────────────────────────────────────────┤
│                        ↓                                      │
│              ZIGBEE 3.0 (2016)                               │
│                                                               │
│  ✓ Унификация всех профилей                                  │
│  ✓ Обязательная сертификация                                 │
│  ✓ Green Power (energy harvesting)                           │
│  ✓ Touchlink commissioning                                   │
│  ✓ Install codes для безопасности                            │
└──────────────────────────────────────────────────────────────┘
```

**Почему понадобился Zigbee 3.0?** Фрагментация убивала экосистему. Philips Hue использовал Light Link, датчики — Home Automation, счётчики электроэнергии — Smart Energy. Устройства с разными профилями не видели друг друга в одной сети! Zigbee 3.0 (2016) объединил профили и ввёл обязательную сертификацию — теперь "Zigbee 3.0 Certified" гарантирует совместимость.

**Install codes** решили проблему безопасности: раньше сеть в режиме pairing раздавала ключ открытым текстом, атакующий мог его перехватить. Install code — уникальный ключ на этикетке устройства, который нужно ввести вручную или отсканировать QR. Перехватить невозможно.

---

## Thread

### Почему появился Thread?

Google (Nest), ARM, Samsung и другие в 2014 году осознали главную проблему Zigbee: **он не говорит на языке интернета**. Zigbee использует собственные 16-битные адреса и проприетарный сетевой уровень. Чтобы лампа Zigbee получила команду из облака, нужен gateway-переводчик.

```
Проблема Zigbee:
─────────────────
• Не IP-based → нужен gateway/translator
• Проприетарные application layers
• Фрагментация профилей

Thread решает:
─────────────────
• Native IPv6 → прямая IP адресация
• 6LoWPAN compression для 802.15.4
• Стандартные IP протоколы (UDP, CoAP)
• Открытый стандарт (Thread Group)
```

**Ключевое решение Thread: IPv6 для IoT.** Каждое Thread-устройство имеет полноценный IPv6-адрес. Смартфон в любой точке мира может напрямую адресовать датчик температуры в спальне (через Border Router). Не нужен проприетарный протокол между облаком и устройством.

**6LoWPAN — как IPv6 влезает в 127 байт?** IPv6-заголовок занимает 40 байт, а 802.15.4 фрейм — максимум 127 байт. 6LoWPAN сжимает заголовки до 2-7 байт через контекстную компрессию: адреса выводятся из MAC-адресов, многие поля опускаются (они одинаковы для всей сети).

### Thread архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                     THREAD STACK                                 │
├─────────────────────────────────────────────────────────────────┤
│  Application Layer                                               │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ CoAP, MQTT, HTTP                                          │  │
│  │ (любой IP-based протокол)                                 │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  Transport Layer                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ UDP / DTLS                                                │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  Network Layer                                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ IPv6 + 6LoWPAN                                            │  │
│  │ - Mesh routing (MLE - Mesh Link Establishment)            │  │
│  │ - RPL routing protocol                                    │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  MAC Layer (IEEE 802.15.4)                                       │
│  Physical Layer (IEEE 802.15.4)                                  │
│  (Идентично Zigbee)                                             │
└─────────────────────────────────────────────────────────────────┘
```

### Thread устройства

```
┌─────────────────────────────────────────────────────────────────┐
│                    THREAD DEVICE ROLES                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  BORDER ROUTER              ROUTER               END DEVICE      │
│  ┌─────────────┐           ┌───────┐            ┌───────────┐   │
│  │   BR  ═══   │           │   R   │            │    ED     │   │
│  │     WiFi/   │           │       │            │  (SED/    │   │
│  │     Ethernet│           │       │            │   MED)    │   │
│  └─────────────┘           └───────┘            └───────────┘   │
│                                                                  │
│  Мост в IP сеть            Маршрутизация        Конечные узлы   │
│  - HomePod mini            - Постоянно on       - SED: sleepy   │
│  - Google Nest Hub         - До 32 children     - MED: minimal  │
│  - Echo 4th gen            - Parent для ED                      │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  LEADER                    COMMISSIONER                          │
│  ┌───────────────┐         ┌─────────────┐                      │
│  │   Elected     │         │  Joins new  │                      │
│  │   Router      │         │   devices   │                      │
│  └───────────────┘         └─────────────┘                      │
│                                                                  │
│  Управляет сетью           Комиссионер для                      │
│  Автовыбор при падении     добавления устройств                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Border Router — мост между мирами.** Thread-сеть изолирована на физическом уровне (802.15.4), но Border Router транслирует IPv6-пакеты в WiFi/Ethernet. HomePod mini, Nest Hub, Echo 4th gen — все они содержат Thread-радио и выступают Border Router. Важно: несколько Border Router в одной сети — это нормально и даже рекомендуется (резервирование).

**Leader выбирается автоматически.** В отличие от Zigbee Coordinator (статически назначается), Thread Leader — результат distributed election. При падении Leader'а роутеры за секунды выберут нового. Это делает Thread сеть устойчивее к единой точке отказа.

### Thread сеть

```
┌─────────────────────────────────────────────────────────────────┐
│                 THREAD NETWORK TOPOLOGY                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│    Internet                                                      │
│        │                                                         │
│   ┌────┴────┐                                                   │
│   │  WiFi   │                                                   │
│   │ Router  │                                                   │
│   └────┬────┘                                                   │
│        │                                                         │
│   ┌────┴────┐         Thread Network                            │
│   │ Border  │═══════════════════════════════════╗               │
│   │ Router  │  Thread                           ║               │
│   └────┬────┘  Partition                        ║               │
│        │                                         ║               │
│   ┌────┴────┐      ┌─────────┐      ┌─────────┐ ║               │
│   │ Router  │──────│ Router  │──────│ Router  │ ║               │
│   │ (Leader)│      │         │      │         │ ║               │
│   └────┬────┘      └────┬────┘      └────┬────┘ ║               │
│        │                │                │      ║               │
│   ┌────┴────┐      ┌────┴────┐      ┌────┴────┐ ║               │
│   │   SED   │      │   MED   │      │   SED   │ ║               │
│   │ (sensor)│      │ (switch)│      │ (sensor)│ ║               │
│   └─────────┘      └─────────┘      └─────────┘ ║               │
│                                                  ║               │
│   ═══════════════════════════════════════════════╝               │
│                                                                  │
│   SED = Sleepy End Device (батарея, просыпается периодически)   │
│   MED = Minimal End Device (больше памяти, чаще активен)        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**SED vs MED — зачем два типа End Device?** SED (Sleepy) спит почти всё время, просыпается по таймеру или при событии (нажатие кнопки, сработал датчик). Идеально для батарейных устройств. MED (Minimal) чаще активен, может принимать сообщения с меньшей задержкой, но потребляет больше. Выключатель света — MED (нужна быстрая реакция), датчик открытия двери — SED (событие редкое).

---

## Matter

### Почему Matter изменил индустрию

До 2022 года умный дом был адом несовместимости. Купил лампу — работает только с Alexa. Датчик — только с HomeKit. Каждый производитель тратил ресурсы на 4 разные интеграции (Apple, Google, Amazon, Samsung), и всё равно пользователь не мог создать единую экосистему.

**Project CHIP (2019)** — Apple, Google, Amazon и Samsung впервые в истории сели за один стол. Конкуренты поняли: фрагментация вредит всем. В 2022 году CHIP переименовали в Matter и выпустили версию 1.0.

### Unified Smart Home

```
┌─────────────────────────────────────────────────────────────────┐
│                 MATTER: УНИФИКАЦИЯ                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ДО MATTER:                                                      │
│  ──────────                                                      │
│  HomeKit только с Apple                                          │
│  Google Home только с Google                                     │
│  Alexa только с Amazon                                           │
│  SmartThings только с Samsung                                    │
│                                                                  │
│  Производитель → 4 разные интеграции → 4x работа                │
│                                                                  │
│  ─────────────────────────────────────────────────────────────  │
│                                                                  │
│  С MATTER:                                                       │
│  ─────────                                                       │
│  ┌─────────┐                                                    │
│  │  Apple  │──┐                                                 │
│  │ HomeKit │  │                                                 │
│  └─────────┘  │      ┌─────────────────┐                        │
│  ┌─────────┐  │      │                 │      ┌─────────────┐   │
│  │ Google  │──┼──────│     MATTER      │──────│   Device    │   │
│  │  Home   │  │      │   (standard)    │      │ (one cert)  │   │
│  └─────────┘  │      │                 │      └─────────────┘   │
│  ┌─────────┐  │      └─────────────────┘                        │
│  │ Amazon  │──┤                                                 │
│  │  Alexa  │  │                                                 │
│  └─────────┘  │                                                 │
│  ┌─────────┐  │                                                 │
│  │ Samsung │──┘                                                 │
│  └─────────┘                                                    │
│                                                                  │
│  Одна сертификация → работает везде                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Что изменилось для производителей?** Вместо 4 сертификаций (HomeKit, Works with Alexa, Google Home, SmartThings) — одна Matter. Снижение затрат в 3-4 раза. Это особенно важно для небольших компаний: раньше выйти на рынок умного дома стоило сотни тысяч долларов только на сертификации.

**Что изменилось для пользователей?** Устройство с логотипом Matter гарантированно работает со всеми экосистемами. Причём одновременно: одна лампа может управляться через "Hey Siri", "OK Google" и "Alexa" без перенастройки.

### Matter архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                     MATTER STACK                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │           APPLICATION LAYER                                │  │
│  │  Device Types: Light, Lock, Thermostat, Sensor...         │  │
│  │  Clusters: On/Off, Level, Color, DoorLock...              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            │                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │           INTERACTION MODEL                                │  │
│  │  Read, Write, Invoke, Subscribe                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            │                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │           ACTION FRAMING                                   │  │
│  │  TLV encoding (Type-Length-Value)                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            │                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │           SECURITY                                         │  │
│  │  CASE (Certificate Authenticated Session Est.)            │  │
│  │  PASE (Passcode Authenticated Session Est.)               │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            │                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │           MESSAGE LAYER                                    │  │
│  │  Reliable messaging, counters, encryption                 │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            │                                     │
│  ┌─────────────────────────┴─────────────────────────────────┐  │
│  │                   TRANSPORT                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │    WiFi     │  │   Thread    │  │    Ethernet     │   │  │
│  │  │  (IP/UDP)   │  │  (IP/UDP)   │  │    (IP/UDP)     │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  Note: BLE используется только для commissioning                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Почему Matter работает поверх разных транспортов?** Батарейный датчик на WiFi — это нонсенс (WiFi потребляет слишком много). Поэтому Matter позволяет использовать Thread для батарейных устройств и WiFi/Ethernet для устройств с постоянным питанием. Прикладной уровень (команды включить/выключить) одинаков независимо от транспорта.

**BLE только для commissioning** — первоначальной настройки. Телефон по BLE передаёт WiFi-пароль или Thread credentials устройству. После этого BLE отключается, устройство переходит на IP-транспорт. Это решает проблему курицы и яйца: как подключить устройство к WiFi, если оно ещё не в сети?

**PASE vs CASE:** PASE (Passcode) — первое подключение по PIN-коду с коробки. CASE (Certificate) — все последующие сессии по сертификатам. Это защищает от MITM: даже если атакующий перехватит первый обмен, без физического доступа к устройству (PIN на этикетке) он не сможет его скомпрометировать.

### Multi-Admin (Fabrics)

```
┌─────────────────────────────────────────────────────────────────┐
│            MATTER MULTI-ADMIN (FABRICS)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Одно устройство может принадлежать нескольким "фабрикам":      │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Smart Bulb                            │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │                 FABRICS                          │    │    │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐   │    │    │
│  │  │  │  Apple    │  │  Google   │  │  Amazon   │   │    │    │
│  │  │  │  HomeKit  │  │   Home    │  │  Alexa    │   │    │    │
│  │  │  │           │  │           │  │           │   │    │    │
│  │  │  │ Fabric #1 │  │ Fabric #2 │  │ Fabric #3 │   │    │    │
│  │  │  └───────────┘  └───────────┘  └───────────┘   │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Каждая fabric имеет:                                           │
│  • Свой Root CA certificate                                      │
│  • Свои ACL (Access Control Lists)                              │
│  • Независимый контроль                                          │
│                                                                  │
│  "Hey Siri, turn on the light" ← работает                       │
│  "Hey Google, turn on the light" ← тоже работает                │
│  "Alexa, turn on the light" ← тоже работает                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Fabrics — революционная идея Matter.** До Matter устройство принадлежало одной экосистеме. Хотите управлять через Alexa? Сбросьте и перенастройте. Matter позволяет одному устройству принадлежать нескольким "фабрикам" одновременно.

**Как это работает технически?** Каждая фабрика — это отдельный Root CA (центр сертификации). Устройство хранит до 5 наборов credentials (Apple, Google, Amazon...). При получении команды устройство проверяет сертификат отправителя и выполняет команду, если он от известной фабрики.

**Безопасность:** Фабрики изолированы. Apple не может управлять устройствами в "фабрике" Google и наоборот. ACL (Access Control Lists) настраиваются для каждой фабрики отдельно. Владелец может удалить фабрику, не трогая остальные.

**Практические сценарии Multi-Admin:**

```
Сценарий 1: Семья с разными экосистемами
──────────────────────────────────────────
• Муж: iPhone, HomePod, "Hey Siri"
• Жена: Android, Nest Hub, "OK Google"
• До Matter: Кто покупает лампу, тот и управляет
• С Matter: Одна лампа, оба управляют из своих экосистем

Сценарий 2: Арендодатель + арендатор
────────────────────────────────────
• Арендодатель: Fabric 1 — полный контроль, мониторинг
• Арендатор: Fabric 2 — управление, но не может удалить устройство
• При выезде: Удаляем Fabric 2, устройства остаются

Сценарий 3: Home Assistant + производитель
──────────────────────────────────────────
• Fabric 1: Home Assistant (локальное управление)
• Fabric 2: Приложение производителя (обновления прошивки)
• Преимущество: Облако производителя упало? Home Assistant работает!
```

### Matter Device Types

```
Matter 1.0+ Device Types:

Lighting:
├── On/Off Light
├── Dimmable Light
├── Color Temperature Light
├── Extended Color Light
└── On/Off Light Switch

Smart Plugs/Outlets:
├── On/Off Plug-in Unit
└── Dimmable Plug-in Unit

Sensors:
├── Contact Sensor (door/window)
├── Light Sensor
├── Occupancy Sensor
├── Temperature Sensor
└── Humidity Sensor

HVAC:
├── Thermostat
├── Fan
└── Air Quality Sensor

Closures:
├── Door Lock
├── Window Covering
└── Garage Door

Media:
├── Basic Video Player
├── Casting Video Player
├── Speaker
└── Content App

Matter 1.2+ (новые):
├── Robot Vacuum
├── Smoke/CO Detector
├── Air Purifier
├── Refrigerator
├── Dishwasher
└── EV Charger
```

---

## NFC

### Почему NFC работает на сантиметрах, а не метрах?

Короткий радиус — не баг, а фича. NFC создавался для **безопасных транзакций**: платежи, пропуска, ключи. Если бы NFC работал на метрах, карту в кармане можно было бы считать незаметно. 10 см требуют осознанного действия — поднести телефон/карту к терминалу.

**Физика:** NFC работает на 13.56 MHz — это не радиоволны в привычном смысле, а индуктивная связь (как трансформатор). Катушки в телефоне и метке образуют магнитную связь только вблизи. Бонус: пассивные метки не нужно заряжать — они получают энергию от электромагнитного поля считывателя.

### NFC основы

```
┌─────────────────────────────────────────────────────────────────┐
│                     NFC OVERVIEW                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Частота:    13.56 MHz (ISM band)                               │
│  Дальность:  < 10 см (обычно < 4 см)                            │
│  Скорость:   106, 212, 424, 848 kbps                            │
│  Стандарты:  ISO 14443, ISO 15693, ISO 18092 (ECMA-340)         │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  РЕЖИМЫ РАБОТЫ:                                                 │
│                                                                  │
│  1. READER/WRITER                                                │
│     ┌──────────┐        ┌──────────┐                            │
│     │  Phone   │ ─────► │   Tag    │                            │
│     │ (active) │        │(passive) │                            │
│     └──────────┘        └──────────┘                            │
│     Чтение/запись меток, URL, vCard                             │
│                                                                  │
│  2. PEER-TO-PEER (SNEP/LLCP)                                    │
│     ┌──────────┐        ┌──────────┐                            │
│     │ Phone A  │ ◄────► │ Phone B  │                            │
│     │ (active) │        │ (active) │                            │
│     └──────────┘        └──────────┘                            │
│     Android Beam (deprecated), обмен данными                    │
│                                                                  │
│  3. CARD EMULATION (HCE)                                        │
│     ┌──────────┐        ┌──────────┐                            │
│     │ Terminal │ ─────► │  Phone   │                            │
│     │ (reader) │        │  (card)  │                            │
│     └──────────┘        └──────────┘                            │
│     Платежи (Google Pay, Apple Pay), проездные                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Три режима — три сценария:**
- **Reader/Writer** — телефон активен, метка пассивна. Применение: прочитать URL с рекламного постера, записать WiFi-пароль на метку для гостей.
- **Peer-to-Peer** — оба устройства активны. Android Beam (устарел), но идея осталась: передать контакт, URL, файл касанием телефонов.
- **Card Emulation** — телефон притворяется картой. Google Pay, Apple Pay работают именно так: терминал думает, что считывает банковскую карту, но это телефон генерирует одноразовые токены.

### NFC Tag Types

```
┌───────────────────────────────────────────────────────────────────┐
│                    NFC TAG TYPES (NFC Forum)                       │
├─────────┬──────────┬──────────┬──────────┬───────────┬───────────┤
│ Type    │ Standard │ Memory   │ Speed    │ R/W       │ Use Case  │
├─────────┼──────────┼──────────┼──────────┼───────────┼───────────┤
│ Type 1  │ ISO14443A│ 96B-2KB  │ 106 kbps │ Read/Write│ Cheap tags│
│ Type 2  │ ISO14443A│ 48B-2KB  │ 106 kbps │ Read/Write│ NTAG21x   │
│ Type 3  │ FeliCa   │ 1MB max  │ 212/424  │ Read/Write│ Japan     │
│ Type 4  │ ISO14443A│ 32KB     │ 106-424  │ Read/Write│ Secure    │
│ Type 5  │ ISO15693 │ 64KB     │ 26 kbps  │ Read/Write│ Industrial│
├─────────┴──────────┴──────────┴──────────┴───────────┴───────────┤
│                                                                   │
│  Популярные чипы:                                                │
│  • NTAG213: 144 bytes, URL, vCard                                │
│  • NTAG215: 504 bytes, amiibo                                    │
│  • NTAG216: 888 bytes                                            │
│  • MIFARE Classic: 1K/4K, access control (взломан!)              │
│  • MIFARE DESFire: secure, AES encryption                        │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

**Почему так много типов?** Исторические причины. Type 1-2 (ISO 14443A) — западный стандарт. Type 3 (FeliCa) — японский (Sony), доминирует в Японии для транспортных карт. Type 5 (ISO 15693) — промышленный, читается с большего расстояния (до 1 м), используется на складах.

**MIFARE Classic — урок плохой криптографии.** В 2008 году исследователи взломали проприетарный алгоритм Crypto-1. Теперь клонировать MIFARE Classic может любой с дешёвым NFC-ридером. Не используйте для безопасности! MIFARE DESFire с AES-128 — современная безопасная альтернатива.

**Практика:** Для своих проектов берите NTAG213 (144 байт, достаточно для URL) или NTAG216 (888 байт, для более сложных данных). Они дешёвые (~$0.10-0.30), широко поддерживаются и безопасны (нет криптографии для взлома — данные открыты, но это и не нужно для URL).

### NDEF Format

```
┌─────────────────────────────────────────────────────────────────┐
│            NDEF (NFC Data Exchange Format)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  NDEF Message:                                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Record 1 │ Record 2 │ Record 3 │ ... │ Record N           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  NDEF Record:                                                    │
│  ┌─────────┬──────────┬──────────┬─────────┬─────────────────┐  │
│  │ Flags   │ Type Len │ Payl Len │  Type   │    Payload      │  │
│  │ (1B)    │  (1B)    │ (1/4B)   │ (var)   │     (var)       │  │
│  └─────────┴──────────┴──────────┴─────────┴─────────────────┘  │
│                                                                  │
│  Flags byte:                                                     │
│  ┌───┬───┬───┬───┬───┬───┬───┬───┐                              │
│  │MB │ME │CF │SR │IL │    TNF    │                              │
│  └───┴───┴───┴───┴───┴───┴───┴───┘                              │
│  MB = Message Begin                                              │
│  ME = Message End                                                │
│  CF = Chunk Flag                                                 │
│  SR = Short Record (payload < 256 bytes)                         │
│  IL = ID Length present                                          │
│  TNF = Type Name Format (3 bits)                                 │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  TNF Values:                                                     │
│  0x00 = Empty                                                    │
│  0x01 = NFC Forum well-known type (T, U, Sp, etc.)              │
│  0x02 = Media type (MIME)                                        │
│  0x03 = Absolute URI                                             │
│  0x04 = NFC Forum external type                                  │
│                                                                  │
│  Well-known types:                                               │
│  "T"  = Text record                                              │
│  "U"  = URI record                                               │
│  "Sp" = Smart Poster                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Android NFC API

```kotlin
// AndroidManifest.xml
// <uses-permission android:name="android.permission.NFC" />
// <uses-feature android:name="android.hardware.nfc" android:required="true" />

class NfcActivity : AppCompatActivity() {

    private lateinit var nfcAdapter: NfcAdapter
    private lateinit var pendingIntent: PendingIntent

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        nfcAdapter = NfcAdapter.getDefaultAdapter(this)
            ?: run {
                // NFC не поддерживается
                finish()
                return
            }

        // PendingIntent для foreground dispatch
        pendingIntent = PendingIntent.getActivity(
            this, 0,
            Intent(this, javaClass).addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP),
            PendingIntent.FLAG_MUTABLE
        )
    }

    override fun onResume() {
        super.onResume()
        // Включаем foreground dispatch для приоритетного получения NFC
        nfcAdapter.enableForegroundDispatch(this, pendingIntent, null, null)
    }

    override fun onPause() {
        super.onPause()
        nfcAdapter.disableForegroundDispatch(this)
    }

    override fun onNewIntent(intent: Intent) {
        super.onNewIntent(intent)

        when (intent.action) {
            NfcAdapter.ACTION_NDEF_DISCOVERED -> {
                // NDEF-formatted tag
                val messages = intent.getParcelableArrayExtra(
                    NfcAdapter.EXTRA_NDEF_MESSAGES
                )?.map { it as NdefMessage }

                messages?.forEach { message ->
                    message.records.forEach { record ->
                        handleNdefRecord(record)
                    }
                }
            }
            NfcAdapter.ACTION_TAG_DISCOVERED -> {
                // Any tag (fallback)
                val tag = intent.getParcelableExtra<Tag>(NfcAdapter.EXTRA_TAG)
                tag?.let { readTag(it) }
            }
        }
    }

    private fun handleNdefRecord(record: NdefRecord) {
        when (record.tnf) {
            NdefRecord.TNF_WELL_KNOWN -> {
                when {
                    record.type.contentEquals(NdefRecord.RTD_URI) -> {
                        val uri = parseUriRecord(record)
                        Log.d("NFC", "URI: $uri")
                    }
                    record.type.contentEquals(NdefRecord.RTD_TEXT) -> {
                        val text = parseTextRecord(record)
                        Log.d("NFC", "Text: $text")
                    }
                }
            }
            NdefRecord.TNF_MIME_MEDIA -> {
                val mimeType = String(record.type, Charsets.UTF_8)
                Log.d("NFC", "MIME: $mimeType")
            }
        }
    }

    private fun parseUriRecord(record: NdefRecord): String {
        val payload = record.payload
        // First byte is URI prefix code
        val prefixCode = payload[0].toInt() and 0xFF
        val prefixes = arrayOf(
            "", "http://www.", "https://www.", "http://", "https://",
            "tel:", "mailto:", "ftp://anonymous:anonymous@ftp.", "ftp://ftp.",
            // ... more prefixes
        )
        val prefix = if (prefixCode < prefixes.size) prefixes[prefixCode] else ""
        return prefix + String(payload, 1, payload.size - 1, Charsets.UTF_8)
    }

    private fun parseTextRecord(record: NdefRecord): String {
        val payload = record.payload
        val statusByte = payload[0].toInt() and 0xFF
        val langCodeLen = statusByte and 0x3F
        val isUtf16 = (statusByte and 0x80) != 0
        val charset = if (isUtf16) Charsets.UTF_16 else Charsets.UTF_8
        return String(payload, 1 + langCodeLen, payload.size - 1 - langCodeLen, charset)
    }
}
```

### Host Card Emulation (HCE)

```kotlin
// Эмуляция NFC карты для платежей и access control

// AndroidManifest.xml:
// <service android:name=".MyHceService"
//          android:exported="true"
//          android:permission="android.permission.BIND_NFC_SERVICE">
//     <intent-filter>
//         <action android:name="android.nfc.cardemulation.action.HOST_APDU_SERVICE"/>
//     </intent-filter>
//     <meta-data android:name="android.nfc.cardemulation.host_apdu_service"
//                android:resource="@xml/apduservice"/>
// </service>

class MyHceService : HostApduService() {

    companion object {
        // AID (Application ID) - уникальный для приложения
        private val MY_AID = byteArrayOf(
            0xF0.toByte(), 0x01, 0x02, 0x03, 0x04, 0x05, 0x06
        )

        // APDU команды
        private const val SELECT_INS = 0xA4.toByte()
        private const val READ_INS = 0xB0.toByte()

        // Статусы
        private val STATUS_SUCCESS = byteArrayOf(0x90.toByte(), 0x00)
        private val STATUS_FAILED = byteArrayOf(0x6F.toByte(), 0x00)
    }

    override fun processCommandApdu(commandApdu: ByteArray, extras: Bundle?): ByteArray {
        // APDU: CLA INS P1 P2 [Lc] [Data] [Le]

        if (commandApdu.size < 4) {
            return STATUS_FAILED
        }

        val ins = commandApdu[1]

        return when (ins) {
            SELECT_INS -> {
                // SELECT command - возвращаем ID приложения
                "MyApp".toByteArray() + STATUS_SUCCESS
            }
            READ_INS -> {
                // READ command - возвращаем данные
                val data = "Hello NFC".toByteArray()
                data + STATUS_SUCCESS
            }
            else -> STATUS_FAILED
        }
    }

    override fun onDeactivated(reason: Int) {
        Log.d("HCE", "Deactivated: $reason")
    }
}

// res/xml/apduservice.xml:
// <?xml version="1.0" encoding="utf-8"?>
// <host-apdu-service xmlns:android="http://schemas.android.com/apk/res/android"
//     android:description="@string/service_desc"
//     android:requireDeviceUnlock="true">
//     <aid-group android:category="other"
//                android:description="@string/aid_desc">
//         <aid-filter android:name="F0010203040506"/>
//     </aid-group>
// </host-apdu-service>
```

---

## LoRa и LoRaWAN

### Почему LoRa достигает километров на батарейке?

Проблема: как передать данные с датчика на ферме (5 км от базовой станции) без сотовой связи и менять батарейку раз в 10 лет?

WiFi, Bluetooth, Zigbee — максимум сотни метров. Сотовые сети — высокое энергопотребление. LoRa (Long Range) от Semtech решает это уникальной модуляцией CSS (Chirp Spread Spectrum).

**Ключевая идея:** вместо передачи на одной частоте сигнал "скользит" по диапазону частот (chirp — щебетание). Даже если сигнал слабый и зашумлённый, приёмник может его декодировать, потому что знает паттерн изменения частоты. Чем медленнее chirp (выше Spreading Factor) — тем надёжнее приём на большем расстоянии, но тем медленнее передача.

### LoRa модуляция

```
┌─────────────────────────────────────────────────────────────────┐
│                     LoRa MODULATION                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  LoRa = Long Range                                               │
│  Проприетарная модуляция Semtech (CSS - Chirp Spread Spectrum)  │
│                                                                  │
│  Частоты:                                                        │
│  • EU: 868 MHz                                                   │
│  • US: 915 MHz                                                   │
│  • Asia: 433 MHz                                                 │
│                                                                  │
│  Параметры:                                                      │
│  ┌────────────────┬───────────────────────────────────────────┐ │
│  │ Spreading      │ SF7-SF12 (выше = дальше, но медленнее)    │ │
│  │ Factor (SF)    │                                           │ │
│  ├────────────────┼───────────────────────────────────────────┤ │
│  │ Bandwidth      │ 125, 250, 500 kHz                         │ │
│  │ (BW)           │                                           │ │
│  ├────────────────┼───────────────────────────────────────────┤ │
│  │ Coding Rate    │ 4/5, 4/6, 4/7, 4/8 (error correction)     │ │
│  │ (CR)           │                                           │ │
│  └────────────────┴───────────────────────────────────────────┘ │
│                                                                  │
│  Дальность vs Скорость:                                          │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ SF7:  5.5 kbps,  ~2 km (urban),  ~5 km (rural)             │ │
│  │ SF12: 0.3 kbps,  ~5 km (urban), ~15 km (rural)             │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Chirp визуализация:                                             │
│                                                                  │
│  Freq ▲           ╱╲    ╱╲                                      │
│       │         ╱    ╲╱    ╲                                    │
│       │       ╱              ╲                                  │
│       │     ╱     Up-chirp    ╲                                 │
│       │   ╱                    ╲                                │
│       └───────────────────────────► Time                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Spreading Factor — главный компромисс.** SF7 — быстро (5.5 kbps), но недалеко. SF12 — медленно (0.3 kbps), но до 15 км в сельской местности. Каждое увеличение SF удваивает время передачи, но улучшает чувствительность на ~2.5 dB.

**Рекомендации по выбору SF:**

```
┌────────────────────────────────────────────────────────────────────┐
│                 ВЫБОР SPREADING FACTOR                             │
├───────────┬────────────┬────────────────┬──────────────────────────┤
│    SF     │  Скорость  │   Дальность    │  Когда использовать      │
├───────────┼────────────┼────────────────┼──────────────────────────┤
│  SF7      │  5.5 kbps  │  ~2 км (город) │  Устройства близко к     │
│           │            │  ~5 км (поле)  │  gateway, много данных   │
├───────────┼────────────┼────────────────┼──────────────────────────┤
│  SF8-SF9  │  1-3 kbps  │  ~3-4 км       │  Средняя дистанция,      │
│           │            │                │  большинство сценариев   │
├───────────┼────────────┼────────────────┼──────────────────────────┤
│  SF10-SF11│  0.5-1 kbps│  ~5-10 км      │  Дальние устройства,     │
│           │            │                │  сложный рельеф          │
├───────────┼────────────┼────────────────┼──────────────────────────┤
│  SF12     │  0.3 kbps  │  ~15 км        │  Максимальная дальность, │
│           │            │                │  редкие передачи         │
└───────────┴────────────┴────────────────┴──────────────────────────┘

Практические советы:
• Начните с ADR (Adaptive Data Rate) — сеть выберет оптимальный SF
• Для прототипа: SF9 — хороший баланс
• SF12 только если SF10-11 не хватает (экономит airtime)
• В городе SF7-8 обычно достаточно (много отражений, gateway близко)
```

**Почему разные частоты в разных регионах?** Регуляторы выделили разные ISM-диапазоны: EU — 868 MHz (duty cycle 1%), US — 915 MHz (frequency hopping), Asia — 433 MHz. Это значит: устройство для EU не будет работать в US без аппаратных изменений.

**Adaptive Data Rate (ADR):** Network Server анализирует качество сигнала и автоматически настраивает SF. Датчик рядом с gateway → SF7 (быстро, экономит airtime). Датчик на границе покрытия → SF12 (медленно, но надёжно).

### LoRaWAN архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                 LoRaWAN ARCHITECTURE                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   End Devices            Gateways            Network Server      │
│                                                                  │
│   ┌─────────┐                                                   │
│   │ Sensor  │───┐        ┌───────────┐                          │
│   └─────────┘   │        │           │                          │
│                 │        │  Gateway  │        ┌──────────────┐  │
│   ┌─────────┐   ├─LoRa──►│     1     │──IP──►│              │  │
│   │ Sensor  │───┤        │           │        │   Network    │  │
│   └─────────┘   │        └───────────┘        │   Server     │  │
│                 │                             │              │  │
│   ┌─────────┐   │        ┌───────────┐        │  (TTN, AWS   │  │
│   │ Sensor  │───┼─LoRa──►│  Gateway  │──IP──►│   Chirpstack │  │
│   └─────────┘   │        │     2     │        │   etc.)      │  │
│                 │        └───────────┘        │              │  │
│   ┌─────────┐   │                             └───────┬──────┘  │
│   │ Sensor  │───┘                                     │         │
│   └─────────┘                                         │         │
│                                                       ▼         │
│                                              ┌──────────────┐   │
│                                              │ Application  │   │
│                                              │   Server     │   │
│                                              └──────────────┘   │
│                                                                  │
│   Особенности:                                                  │
│   • Star-of-stars топология                                      │
│   • Один пакет может прийти на несколько gateways               │
│   • Network Server дедуплицирует                                 │
│   • Все шифрование E2E (AppSKey) и network (NwkSKey)            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**LoRa vs LoRaWAN:** LoRa — физический уровень (модуляция). LoRaWAN — протокол поверх (адресация, шифрование, управление сетью). Можно использовать LoRa без LoRaWAN для point-to-point связи, но тогда нужно писать свой протокол.

**Star-of-stars — почему не mesh?** Mesh требует, чтобы узлы были всегда включены для ретрансляции. Это убивает батарею. LoRaWAN выбрал звезду: устройство проснулось → передало → заснуло. Gateway'и с постоянным питанием собирают данные.

**Дедупликация:** Один пакет часто достигает нескольких gateway'ев. Network Server получает копии, выбирает лучшую (по RSSI/SNR), остальные отбрасывает. Это же обеспечивает надёжность: если один gateway упал, пакет придёт через другой.

### LoRaWAN Device Classes

```
┌─────────────────────────────────────────────────────────────────┐
│              LoRaWAN DEVICE CLASSES                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  CLASS A (All devices support)                                   │
│  ──────────────────────────────                                  │
│                                                                  │
│  Uplink    ┌───┐                                                │
│  ──────────┤TX ├────────────────────────────────────────────    │
│            └───┘                                                │
│                 ┌──┐  ┌──┐                                      │
│  Downlink ─────┤RX├──┤RX├───────────────────────────────────    │
│                └──┘  └──┘                                       │
│                RX1   RX2                                        │
│                (1s)  (2s)                                       │
│                                                                  │
│  • Lowest power consumption                                      │
│  • Downlink только после uplink                                  │
│  • Сенсоры, батарейные устройства                                │
│                                                                  │
│  ─────────────────────────────────────────────────────────────  │
│                                                                  │
│  CLASS B (Beacon)                                                │
│  ──────────────────                                              │
│                                                                  │
│  Beacon ──┬────────────┬────────────┬────────────┬──────────    │
│           │            │            │            │               │
│           ▼            ▼            ▼            ▼               │
│  Ping   ┌──┐         ┌──┐        ┌──┐         ┌──┐              │
│  slots  │RX│         │RX│        │RX│         │RX│              │
│         └──┘         └──┘        └──┘         └──┘              │
│                                                                  │
│  • Scheduled downlink в ping slots                               │
│  • GPS-синхронизация времени                                     │
│  • Actuators с предсказуемой latency                             │
│                                                                  │
│  ─────────────────────────────────────────────────────────────  │
│                                                                  │
│  CLASS C (Continuous)                                            │
│  ──────────────────────                                          │
│                                                                  │
│  Uplink    ┌───┐                      ┌───┐                     │
│  ──────────┤TX ├──────────────────────┤TX ├─────────────────    │
│            └───┘                      └───┘                     │
│  Downlink ─┬───────────────────────────┬────────────────────    │
│            │         ALWAYS RX         │                        │
│            └───────────────────────────┘                        │
│                                                                  │
│  • Постоянно слушает (кроме TX)                                  │
│  • Минимальная latency для downlink                              │
│  • Питание от сети (высокое потребление)                         │
│  • Street lights, actuators                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Почему три класса?** Компромисс энергия/latency:
- **Class A** — 99% устройств. После отправки открывается два коротких окна приёма (RX1, RX2). Если сервер хочет послать команду — только в эти окна. Задержка downlink: от секунд до часов (ждём следующего uplink). Батарея: годы.
- **Class B** — beacon синхронизирует время, устройство открывает окна по расписанию. Предсказуемая задержка downlink (~128 сек max). Применение: actuators, где нужна гарантированная реакция.
- **Class C** — всегда слушает. Мгновенный downlink. Но: постоянное потребление ~40 mA. Только с питанием от сети.

### LoRaWAN Activation

```
┌─────────────────────────────────────────────────────────────────┐
│              LoRaWAN ACTIVATION METHODS                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  OTAA (Over-The-Air Activation) — рекомендуется                 │
│  ─────────────────────────────────────────────                   │
│                                                                  │
│  Device credentials (burned in):                                 │
│  • DevEUI (64-bit device identifier)                             │
│  • AppEUI/JoinEUI (64-bit application identifier)                │
│  • AppKey (128-bit AES root key)                                 │
│                                                                  │
│  Join procedure:                                                 │
│  ┌────────┐                              ┌─────────────┐        │
│  │ Device │───Join Request──────────────►│   Network   │        │
│  │        │   (DevEUI, AppEUI, DevNonce) │   Server    │        │
│  │        │                              │             │        │
│  │        │◄──Join Accept────────────────│             │        │
│  │        │   (DevAddr, NwkSKey,         │             │        │
│  │        │    AppSKey derived)          │             │        │
│  └────────┘                              └─────────────┘        │
│                                                                  │
│  ─────────────────────────────────────────────────────────────  │
│                                                                  │
│  ABP (Activation By Personalization) — для тестов               │
│  ──────────────────────────────────────────────                  │
│                                                                  │
│  Pre-provisioned (hardcoded):                                    │
│  • DevAddr (32-bit device address)                               │
│  • NwkSKey (128-bit network session key)                         │
│  • AppSKey (128-bit application session key)                     │
│                                                                  │
│  Минусы ABP:                                                     │
│  • Нет key rotation                                              │
│  • Frame counter reset issues                                    │
│  • Security risks                                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**OTAA vs ABP — почему OTAA лучше?**

ABP кажется проще: захардкодил ключи — и работает. Но:
1. **Frame counter reset:** При перезагрузке устройства счётчик обнуляется. Сервер отклоняет пакеты с меньшим счётчиком (защита от replay). Нужно вручную сбрасывать на сервере или хранить счётчик в EEPROM.
2. **Нет key rotation:** Ключи навсегда. Если скомпрометированы — менять прошивку на всех устройствах.
3. **Нет roaming:** Ключи привязаны к конкретному Network Server.

OTAA генерирует сессионные ключи при каждом Join. Перезагрузка? Join заново, новые ключи, счётчик с нуля. Безопасно и удобно.

### LoRaWAN безопасность

```
┌─────────────────────────────────────────────────────────────────┐
│              LoRaWAN SECURITY (v1.0.x / v1.1)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Два уровня шифрования:                                          │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  Application Payload                       │  │
│  │               (encrypted with AppSKey)                     │  │
│  │           ↑ end-to-end encryption ↑                        │  │
│  └───────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     MAC Frame                              │  │
│  │              (MIC with NwkSKey)                            │  │
│  │           ↑ network integrity ↑                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
│  LoRaWAN 1.1 improvements:                                       │
│  ─────────────────────────                                       │
│  • Separate Join Server                                          │
│  • NwkSKey split: NwkSEncKey, SNwkSIntKey, FNwkSIntKey          │
│  • Roaming support                                               │
│  • Replay attack protection (improved)                           │
│                                                                  │
│  Frame counters:                                                 │
│  ─────────────                                                   │
│  • FCntUp: device → server                                       │
│  • FCntDown: server → device                                     │
│  • Monotonically increasing                                      │
│  • Replay protection                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Два уровня шифрования — зачем?**
- **NwkSKey** (Network Session Key) — целостность и шифрование на сетевом уровне. Network Server видит, кто отправил пакет, но не видит payload.
- **AppSKey** (Application Session Key) — end-to-end шифрование. Только Application Server расшифровывает данные. Network Server (TTN, Chirpstack) физически не может прочитать ваши данные.

Это разделение позволяет использовать публичные сети (TTN) для чувствительных данных: оператор сети видит метаданные (кто, когда, откуда), но не содержимое.

**LoRaWAN 1.1 улучшения:** Разделили NwkSKey на три ключа для защиты от roaming-атак. Добавили отдельный Join Server — теперь даже если Network Server скомпрометирован, он не может выдать себя за устройство.

---

## Zigbee vs Thread vs Matter

```
┌─────────────────────────────────────────────────────────────────┐
│          ZIGBEE vs THREAD vs MATTER                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│                   Zigbee        Thread         Matter            │
│  ─────────────────────────────────────────────────────────────  │
│  Physical         802.15.4      802.15.4       WiFi/Thread/     │
│  Layer                                         Ethernet          │
│                                                                  │
│  Network          Zigbee NWK    IPv6/6LoWPAN   IPv6             │
│  Layer            (proprietary)                                  │
│                                                                  │
│  Application      ZCL           Любой          Matter Data      │
│  Layer            (clusters)    (CoAP, etc.)   Model            │
│                                                                  │
│  IP-based         Нет           Да             Да               │
│                                                                  │
│  Interop          Zigbee 3.0    Thread         Все экосистемы   │
│                   certified     certified       (Apple, Google,  │
│                                                Amazon, Samsung) │
│                                                                  │
│  Gateway          Обязателен    Border Router  Controller       │
│  needed           (translator)  (IP bridge)    (optional)       │
│                                                                  │
│  ─────────────────────────────────────────────────────────────  │
│                                                                  │
│  ВЗАИМОСВЯЗЬ:                                                   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      MATTER                              │    │
│  │              (application layer)                         │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │                 THREAD                           │    │    │
│  │  │            (network layer)                       │    │    │
│  │  │  ┌─────────────────────────────────────────┐    │    │    │
│  │  │  │            IEEE 802.15.4                 │    │    │    │
│  │  │  │         (physical layer)                │    │    │    │
│  │  │  └─────────────────────────────────────────┘    │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Matter может работать поверх:                                  │
│  • Thread (для батарейных устройств)                            │
│  • WiFi (для powered устройств)                                 │
│  • Ethernet (для хабов)                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**Итог: что выбрать в 2024+?**

- **Zigbee** — если уже есть экосистема (Philips Hue, IKEA Tradfri). Огромный выбор устройств, но vendor lock-in и нужен bridge.
- **Thread** — будущее для батарейных устройств. IPv6, нет vendor lock-in, но пока мало устройств.
- **Matter** — если важна мультиплатформенность. Новые устройства всё чаще Matter-certified.

**Практический совет:** Thread + Matter — лучшая комбинация. Thread для транспорта (энергоэффективность), Matter для совместимости (Apple + Google + Amazon). HomePod mini / Nest Hub / Echo уже работают как Thread Border Router и Matter Controller.

---

## Практические примеры

### Zigbee2MQTT интеграция

```yaml
# docker-compose.yml для Zigbee2MQTT
version: '3.8'
services:
  zigbee2mqtt:
    container_name: zigbee2mqtt
    image: koenkk/zigbee2mqtt
    restart: unless-stopped
    volumes:
      - ./zigbee2mqtt-data:/app/data
      - /run/udev:/run/udev:ro
    ports:
      - 8080:8080
    environment:
      - TZ=Europe/Moscow
    devices:
      # Zigbee USB adapter (CC2531, Conbee II, etc.)
      - /dev/ttyUSB0:/dev/ttyUSB0

# configuration.yaml
mqtt:
  base_topic: zigbee2mqtt
  server: mqtt://mosquitto:1883

serial:
  port: /dev/ttyUSB0
  adapter: zstack  # или deconz, ezsp

frontend:
  port: 8080

advanced:
  network_key: GENERATE  # Важно для безопасности!
  pan_id: GENERATE

devices:
  '0x00158d0001234567':
    friendly_name: 'living_room_temp'
  '0x00158d0001234568':
    friendly_name: 'bedroom_motion'
```

### Home Assistant Matter интеграция

```yaml
# Home Assistant configuration.yaml
matter:
  # Matter Server запускается как addon или отдельный container

# Commissioning через QR код или Manual Pairing Code
# Все Matter устройства автоматически появляются в HA
```

---

## Подводные камни

Эти проблемы не очевидны из документации, но приводят к часам отладки на практике.

### Проблема 1: Zigbee интерференция

WiFi и Zigbee делят 2.4 GHz диапазон. Если координатор Zigbee на канале 11, а WiFi router на канале 1 — они будут мешать друг другу. Результат: устройства "отваливаются", команды не доходят, датчики теряют связь.

```
2.4 GHz band congestion:

┌────────────────────────────────────────────────────────────────┐
│  WiFi Channel 1    │  WiFi Channel 6    │  WiFi Channel 11     │
│  (2401-2423 MHz)   │  (2426-2448 MHz)   │  (2451-2473 MHz)    │
├────────────────────┴────────────────────┴────────────────────┤
│  Zigbee channels: 11-26 (2405-2480 MHz)                       │
│                                                                │
│  Рекомендации:                                                │
│  • WiFi на канале 1 → Zigbee на канале 25-26                  │
│  • WiFi на канале 11 → Zigbee на канале 11-15                 │
│  • Zigbee каналы 15, 20, 25 минимально пересекаются           │
└────────────────────────────────────────────────────────────────┘
```

### Проблема 2: Thread Border Router

```
Thread без Border Router:
─────────────────────────
• Thread mesh работает изолированно
• Нет доступа из WiFi/Ethernet сети
• Нет интернет-подключения

Решения:
• Apple HomePod mini / TV 4K
• Google Nest Hub (2nd gen) / Hub Max
• Amazon Echo (4th gen)
• Nanoleaf Shapes
• Dedicated Thread BR (Aqara M3)
```

**Почему называется "Border" Router?**

```
Border Router — это ГРАНИЦА между двумя сетями:

┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│     Thread Network              │        IP Network             │
│     (802.15.4 radio)            │        (WiFi/Ethernet)        │
│                                 │                               │
│   ┌─────┐    ┌─────┐           │                               │
│   │Датч.│────│Лампа│           │                               │
│   └──┬──┘    └──┬──┘           │       ┌──────────────┐        │
│      │          │              │       │              │        │
│      └────┬─────┘              │       │   Интернет   │        │
│           │                    │       │   Смартфон   │        │
│      ┌────┴────┐               │       │   Home       │        │
│      │ Border  │═══════════════│═══════│   Assistant  │        │
│      │ Router  │    Граница    │       │              │        │
│      └─────────┘               │       └──────────────┘        │
│                                 │                               │
└─────────────────────────────────────────────────────────────────┘

Border Router выполняет:
• NAT64/DNS64: трансляция IPv6 Thread ↔ IPv4 интернет
• mDNS/DNS-SD: обнаружение Thread устройств из WiFi
• Routing: маршрутизация пакетов между сетями
• Commissioning: добавление новых Thread устройств

Без Border Router Thread mesh — это "островок" без связи с миром.
```

**Сколько Border Router нужно?**

```
Минимум: 1 (обязательно)
Рекомендуется: 2+ (резервирование)

Почему несколько BR полезно:
• Если один BR упал/выключен — сеть продолжает работать
• Распределение нагрузки
• Лучшее покрытие (BR также Thread Router)

HomePod mini + Nest Hub в одном доме = отличная комбинация
(Apple и Google BR не конфликтуют)
```

### Проблема 3: LoRaWAN Fair Use Policy

```
TTN (The Things Network) ограничения:
─────────────────────────────────────

• Uplink: 30 секунд airtime / 24 часа
• Downlink: 10 сообщений / 24 часа

SF12 + 125kHz + 51 bytes = ~2.5 секунды airtime
→ Максимум ~12 сообщений в день!

Рекомендации:
• Используйте SF7-SF9 где возможно
• Минимизируйте payload size
• ADR (Adaptive Data Rate) включён
```

---

## Actionable

**Zigbee/Thread (умный дом):**
- Zigbee: купить координатор (Conbee II, Sonoff ZBDongle-P)
- Настроить Zigbee2MQTT + Home Assistant
- Thread: убедиться что есть Border Router (HomePod, Nest Hub)

**NFC (разработка):**
- Android: enableForegroundDispatch для приоритета
- Тестировать на реальных метках (NTAG213/216)
- HCE для card emulation (платежи, пропуска)

**LoRaWAN (IoT проекты):**
- TTN для прототипов (бесплатно)
- Chirpstack для self-hosted
- Class A для большинства сенсоров

---

## Связь с другими темами

[[network-bluetooth]] — Bluetooth (особенно BLE) является ближайшим «родственником» IoT-протоколов и часто используется совместно с ними. BLE Mesh конкурирует с Zigbee/Thread для умного дома, а BLE используется для commissioning устройств Matter. Понимание различий в энергопотреблении, дальности и топологии между BLE и Zigbee/Thread критически важно для выбора технологии. Рекомендуется изучать оба материала вместе.

[[network-physical-layer]] — все IoT-протоколы работают на определённых радиочастотах (2.4 GHz для Zigbee/Thread, 868/915 MHz для LoRa, 13.56 MHz для NFC), и понимание физического уровня объясняет компромиссы: почему LoRa «стреляет» на километры при низком битрейте, а Zigbee ограничен десятками метров при более высокой скорости. Физический уровень даёт фундамент для осмысленного сравнения протоколов.

[[networking-overview]] — обзорный материал, который помещает IoT-протоколы в контекст всего сетевого стека. Zigbee/Thread/LoRa занимают нишу WPAN/LPWAN, в то время как Wi-Fi и Ethernet — LAN. Понимание общей картины помогает определить, где в архитектуре системы находится gateway между IoT-миром и IP-сетью.

[[android-networking]] — Android является одной из основных платформ для взаимодействия с IoT-устройствами через BLE (commissioning Matter), NFC (метки, платежи) и Wi-Fi Direct. Android API для NFC (enableForegroundDispatch, NDEF) и BLE (BluetoothGatt) требуют понимания протоколов, которые описаны в этом материале.

---

## Источники и дальнейшее чтение

### Официальные спецификации

| Источник | Тип | Описание |
|----------|-----|----------|
| [Zigbee Alliance Specification](https://csa-iot.org/developer-resource/specifications-download-request/) | Официальная документация | Полная спецификация Zigbee 3.0 |
| [Thread Group: What is Thread](https://www.threadgroup.org/What-is-Thread) | Официальная документация | Спецификация Thread, архитектура |
| [Matter Specification (CSA)](https://csa-iot.org/all-solutions/matter/) | Официальная документация | Matter 1.x спецификация и SDK |
| [NFC Forum Specifications](https://nfc-forum.org/build/specifications) | Официальная документация | NDEF, Tag Types, протоколы |
| [LoRa Alliance: LoRaWAN Specification](https://lora-alliance.org/resource_hub/lorawan-specification-v1-0-3/) | Официальная документация | LoRaWAN 1.0.3 и 1.1 |
| [OpenThread (Google)](https://openthread.io/) | Open Source | Референсная реализация Thread |

### История и контекст

| Источник | Тип | Использовано для |
|----------|-----|------------------|
| [Zigbee - Wikipedia](https://en.wikipedia.org/wiki/Zigbee) | Энциклопедия | История Zigbee Alliance, хронология версий |
| [Thread (network protocol) - Wikipedia](https://en.wikipedia.org/wiki/Thread_(network_protocol)) | Энциклопедия | История Thread Group, связь с Nest |
| [Matter (standard) - Wikipedia](https://en.wikipedia.org/wiki/Matter_(standard)) | Энциклопедия | Эволюция Project CHIP → Matter |
| [A Brief History of LoRa (Semtech Blog)](https://blog.semtech.com/a-brief-history-of-lora-three-inventors-share-their-personal-story-at-the-things-conference) | Блог производителя | История создателей LoRa, Cycleo |
| [NFC History - Sony FeliCa](https://www.sony.net/Products/felica/NFC/) | Официальный сайт | История NFC, связь с FeliCa |

### Практические руководства

| Источник | Тип | Описание |
|----------|-----|----------|
| [The Things Network Docs](https://www.thethingsnetwork.org/docs/) | Документация | LoRaWAN на практике, TTN |
| [Zigbee2MQTT Documentation](https://www.zigbee2mqtt.io/) | Open Source | Интеграция Zigbee с Home Assistant |
| [Android NFC Guide](https://developer.android.com/develop/connectivity/nfc) | Официальная документация | NFC API для Android разработчиков |
| [Silicon Labs Thread Fundamentals](https://docs.silabs.com/openthread/latest/thread-fundamentals/01-overview) | Документация | Глубокий разбор Thread стека |

---

**Последняя верификация**: 2026-01-02
**Уровень достоверности**: high

---

## Рекомендуемые книги

- **Townsend K. (2014). Getting Started with Bluetooth Low Energy.** — Практическое введение в BLE, которое помогает понять парадигму GATT и advertising, общую для BLE и IoT-протоколов вроде Zigbee. Полезна для сравнения BLE с другими IoT-технологиями.

- **Tanenbaum A., Wetherall D. (2011). Computer Networks, 5th Edition.** — Академический учебник с разделами о беспроводных сетях, сенсорных сетях и IoT. Даёт теоретический фундамент для понимания mesh-топологий, адресации и маршрутизации в IoT-протоколах.

- **Huitema C. (2000). Routing in the Internet, 2nd Edition.** — Хотя книга фокусируется на интернет-маршрутизации, принципы routing в IP-сетях напрямую применимы к Thread (IPv6 mesh) и пониманию того, как IoT-устройства маршрутизируют данные через промежуточные узлы.

---

---

## Проверь себя

> [!question]- Почему Matter называют "USB-C для умного дома" и какие реальные ограничения он имеет?
> Matter стандартизирует прикладной уровень для умного дома, позволяя устройствам разных производителей работать вместе (как USB-C унифицировал разъёмы). Ограничения: Matter работает только поверх WiFi, Thread и BLE; устройства на Zigbee/Z-Wave требуют bridge; начальная версия покрывает ограниченный набор типов устройств; добавляет overhead к протоколу.

> [!question]- Проект умного здания требует 500 датчиков температуры. Почему Zigbee mesh подходит лучше, чем WiFi?
> WiFi: каждый датчик требует IP, нагружает роутер (максимум ~50-100 клиентов), высокое энергопотребление (батарея на недели). Zigbee: mesh-топология (датчики ретранслируют друг через друга), до 65000 узлов, батарейка на годы, минимальный overhead. Но нужны Zigbee-роутеры (питание от сети) для mesh-backbone.

> [!question]- В чём фундаментальный компромисс IoT-протоколов (треугольник ограничений)?
> Три параметра: дальность, скорость, энергопотребление --- можно оптимизировать максимум два. WiFi: высокая скорость + средняя дальность, но высокое энергопотребление. BLE: низкое энергопотребление + средняя скорость, но малая дальность. LoRa: большая дальность + низкое энергопотребление, но очень низкая скорость (250 bps).

---

## Ключевые карточки

Чем отличаются Zigbee, Thread и Matter?
?
Zigbee --- mesh-протокол на 2.4 GHz, проприетарный прикладной уровень. Thread --- mesh на 802.15.4 с нативным IPv6 (совместим с IP-сетями). Matter --- стандарт прикладного уровня поверх WiFi, Thread, BLE. Matter + Thread = mesh + IP + стандартный протокол умного дома.

Что такое LoRaWAN и для чего он подходит?
?
LoRaWAN --- протокол для IoT на большие расстояния (до 15 км) с минимальным энергопотреблением. Скорость 250 bps - 50 Kbps. Идеально для: метеостанций, трекеров, датчиков уровня воды. Не подходит для: видео, частых обновлений, интерактивных устройств.

Как работает NFC и чем отличается от BLE?
?
NFC --- контактная связь на расстоянии до 10 см, 424 Kbps. Не требует pairing и может работать с пассивными метками (без батареи). BLE --- до 100 метров, требует pairing, батарея обязательна. NFC для: платежей, пропусков, быстрого pairing. BLE для: фитнес-трекеров, аудио, IoT.

Что такое mesh-топология и зачем она нужна IoT?
?
В mesh каждое устройство может ретранслировать данные других. Преимущества: самовосстановление при выходе узла, расширение покрытия, нет единой точки отказа. Zigbee, Thread, BLE Mesh --- реализации mesh. Star-топология (WiFi) проще, но зависит от центрального узла.

В чём проблема интерференции на 2.4 GHz?
?
WiFi, BLE, Zigbee, Thread --- все работают на 2.4 GHz. Микроволновки тоже излучают на 2.4 GHz. В плотной среде устройства мешают друг другу. Решения: frequency hopping (BLE, Bluetooth), разнесение каналов, использование 5 GHz для WiFi, sub-GHz для IoT (LoRa, Z-Wave).

---

## Куда дальше

| Направление | Куда | Зачем |
|-------------|------|-------|
| Следующий шаг | [[network-bluetooth]] | BLE как основной протокол ближнего радиуса для мобильных |
| Углубиться | [[network-cellular]] | NB-IoT и LTE-M как сотовые IoT-альтернативы |
| Смежная тема | [[network-security-fundamentals]] | Безопасность IoT-устройств и протоколов |
| Обзор | [[networking-overview]] | Вернуться к карте раздела |

---

*Последнее обновление: 2026-01-09 --- Добавлены педагогические секции: 5 аналогий (выбор транспорта, mesh vs star, Thread vs Zigbee, Matter как USB-C, LoRa vs Cellular), 6 типичных ошибок с СИМПТОМ/РЕШЕНИЕ, 5 ментальных моделей*
